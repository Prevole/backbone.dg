/*!
 * Ajadmin.Dg v0.0.1
 * Copyright (c) 2012 Laurent Pr√©vost (prevole) <prevole@prevole.ch>
 * Distributed under MIT license
 * https://github.com/prevole/ajadmin.dg
 */
var Dg,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e},__bind=function(e,t){return function(){return e.apply(t,arguments)}};Backbone.Dg=Dg=function(e,t,n,r){var i,s,o,u,a,f,l,c;return Dg={version:"0.0.1"},o=function(e,t){var r,i;e===void 0&&(e={});for(r in t)i=t[r],e[r]===void 0||e[r]===null?e[r]=t[r]:n.isObject(t[r])&&n.isObject(e[r])&&(e[r]=o(e[r],t[r]));return e},l=function(e,t){var n,r,i;r={};for(n in e)i=e[n],t(e,n,i)||(r[n]=i);return r},c={empty:function(e){return"<td class='empty'>No Data</td>"},grid:function(e){return"<div class='dgGrid'><div class='clearfix'><div class='dgPerPage' /><div class='dgToolbar' /><div class='dgQuickSearch' /></div><div class='dgTable' /><div class='clearfix'><div class='dgInfo pull-left' /><div class='dgPager pull-right' /></div></div>"},gridempty:function(e){return"<div class='dgLoading'><div class='progress progress-striped active'><div class='bar' style='width:100%'>Loading data</div></div></div>"},info:function(e){return"<span class='info' />"},pager:function(e){return"<div class='pagination pagination-right' />"},perpage:function(e){return"<div class='form-inline pull-left'><label class='checkbox'>Item per page: </label><select class='per-page input-mini'><option>2</option><option>5</option><option>10</option><option>25</option><option>50</option><option>100</option></select></div>"},quicksearch:function(e){return"<div class='form-inline pull-right qs'><label class='checkbox'>Quick search: </label><input type='text' /></div>"},table:function(e){return"<table class='table table-striped table-hover table-condensed'><tbody/></table>"},toolbar:function(e){return"<div class='form-inline pull-right buttons btn-group'><button class='btn refresh'><i class='icon-refresh'/></button><button class='btn create'><i class='icon-plus'/></button></div>"}},Dg.registerTemplate=function(e,t){return c[e]=t},Dg.ItemView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.initialize=function(e){if(!e.vent)throw new Error("No event aggregator given.");return this.vent=e.vent,this.vent.on("view:refresh",this.refreshView,this)},t.prototype.render=function(){return t.__super__.render.apply(this,arguments),this.vent.trigger("item:rendered",this),this},t.prototype.refreshView=function(e){throw new Error("The method refreshView(info) must be defined.")},t.prototype.update=function(e){return this.vent.trigger("update",e)},t.prototype.close=function(){return this.vent.off("view:refresh",this.refreshView),t.__super__.close.apply(this,arguments)},t}(t.ItemView),Dg.DefaultItemView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.render=function(){return this.beforeRender&&this.beforeRender(),this.trigger("before:render",this),this.trigger("item:before:render",this),this.setElement(r(t.Renderer.render(this.getTemplate(),this.serializeData())),!0),this.bindUIElements(),this.onRender&&this.onRender(),this.trigger("render",this),this.trigger("item:rendered",this),this.vent.trigger("item:rendered",this),this},n}(Dg.ItemView),Dg.InfoView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.template=c.info,t.prototype.refreshView=function(e){return this.$el.text("Showing "+e[f.from]+" to "+e[f.to]+" of "+e[f.items]+" entries")},t}(Dg.DefaultItemView),Dg.QuickSearchView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.template=c.quicksearch,t.prototype.events={"keyup input":"search"},t.prototype.ui={term:"input"},t.prototype.initialize=function(e){var r=this;return t.__super__.initialize.call(this,e),this.searchInternal=n.debounce(function(e){return r.update(n.object([f.term],[r.ui.term.val().trim()]))},300)},t.prototype.refreshView=function(e){return this.ui.term.val(e[f.term])},t.prototype.search=function(e){return this.searchInternal(e)},t}(Dg.DefaultItemView),Dg.PerPageView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.template=c.perpage,t.prototype.events={"change .per-page":"perPage"},t.prototype.ui={perPage:".per-page"},t.prototype.refreshView=function(e){return this.ui.perPage.val(e[f.perPage])},t.prototype.perPage=function(e){return this.update(n.object([f.perPage],[parseInt(this.ui.perPage.val())]))},t}(Dg.DefaultItemView),Dg.ToolbarView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.template=c.toolbar,t.prototype.events={"click .refresh":"refresh","click .create":"create"},t.prototype.ui={create:".create",refresh:".refresh"},t.prototype.refreshView=function(e){return this.ui.refresh.removeClass("disabled"),this.ui.create.removeClass("disabled")},t.prototype.create=function(e){e.preventDefault();if(!this.ui.create.hasClass("disabled"))return this.ui.create.addClass("disabled")},t.prototype.refresh=function(e){e.preventDefault();if(!this.ui.refresh.hasClass("disabled"))return this.ui.refresh.addClass("disabled"),this.update({})},t}(Dg.DefaultItemView),Dg.PagerView=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}var t;return __extends(i,e),i.prototype.template=c.pager,i.prototype.events={"click a":"pagging"},i.prototype.initialize=function(e){return i.__super__.initialize.call(this,e),this.deltaPage=e.deltaPage||2,this.css=n.defaults(e.css||{},{active:"active",disabled:"disabled",page:"page"}),this.texts=n.defaults(e.texts||{},{first:"<<",previous:"<",next:">",last:">>",filler:"..."}),this.numbers=!0,e.numbers!==void 0&&(this.numbers=e.numbers),this.firstAndLast=!0,e.firstAndLast!==void 0&&(this.firstAndLast=e.firstAndLast),this.previousAndNext=!0,e.previousAndNext!==void 0&&(this.previousAndNext=e.previousAndNext),this.info={},this.info[f.page]=0,this.info[f.pages]=0},i.prototype.refreshView=function(e){var n,i,s,o,u,a,l,c;this.info=e,this.$el.empty().hide(),l=r("<ul />"),o=this.info[f.page],u=this.info[f.pages];if(o>0&&u>1){s=o-this.deltaPage,i=o+this.deltaPage,s<=0&&(s=1),i>=u&&(i=u),a=o===1?this.css.disabled:"",this.firstAndLast&&l.append(t.call(this,this.texts.first,"f",a)),this.previousAndNext&&l.append(t.call(this,this.texts.previous,"p",a));if(this.numbers){s>1&&l.append(t.call(this,this.texts.filler,"",this.css.disabled));for(n=c=s;s<=i?c<=i:c>=i;n=s<=i?++c:--c)l.append(t.call(this,""+n,"page",n===o?this.css.active:""));i<u&&l.append(t.call(this,this.texts.filler,"",this.css.disabled))}return a=o===u?this.css.disabled:"",this.previousAndNext&&l.append(t.call(this,this.texts.next,"n",a)),this.firstAndLast&&l.append(t.call(this,this.texts.last,"l",a)),this.$el.append(l).show()}},i.prototype.pagging=function(e){var t,i,s;e.preventDefault(),i=r(e.target);if(!i.parent().hasClass(this.css.disabled)&&!i.parent().hasClass(this.css.active)){s=i.data("type");switch(s){case"f":t=1;break;case"p":t=this.info[f.page]-1>0?this.info[f.page]-1:this.info[f.page];break;case"n":t=this.info[f.page]+1<this.info[f.pages]?this.info[f.page]+1:this.info[f.pages];break;case"l":t=this.info[f.pages];break;default:t=parseInt(r(e.target).text())}if(t!==this.info[f.page])return this.update(n.object([f.page],[t]))}},t=function(e,t,n){var i,s;return i=r("<a/>").attr("href","#").data("type",t).addClass(this.css.page).html(""+e),s=r("<li />").html(i),n&&s.addClass(n),s},i}(Dg.DefaultItemView),Dg.RowView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.tagName="tr",t.prototype.events={"click .edit":"edit","click .delete":"delete"},t.prototype.initialize=function(e){return t.__super__.initialize.call(this,e),this.css=n.defaults(e.css||{},{asc:"sorting-asc",desc:"sorting-desc"}),this.cellTagName=e.cellTagName||"td"},t.prototype.refreshView=function(e){var t,n,i,s,o;if(e[f.sort]){s=this.$el.find(this.cellTagName),o=[];for(n=0,i=s.length;n<i;n++)t=s[n],t=r(t),t.removeClass(""+this.css.asc+" "+this.css.desc),this.css.none&&t.removeClass(this.css.none),e[f.sort][t.index()]?e[f.sort][t.index()]===f.asc?o.push(t.addClass(this.css.asc)):o.push(t.addClass(this.css.desc)):this.css.none?o.push(t.addClass(this.css.none)):o.push(void 0);return o}},t.prototype.edit=function(e){return e.preventDefault(),this.vent.trigger("row:edit",this.model)},t.prototype["delete"]=function(e){return e.preventDefault(),this.vent.trigger("row:delete",this.model)},t}(Dg.ItemView),i=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.template=c.empty,t.prototype.ui={empty:".empty"},t.prototype.initialize=function(e){return this.columns=e.columns,t.__super__.initialize.call(this,e)},t.prototype.onRender=function(){return this.$el.attr("colspan",this.columns)},t.prototype.refreshView=function(e){},t}(Dg.DefaultItemView),s=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.template=c.gridempty,t}(e.Marionette.ItemView),Dg.HeaderView=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return __extends(i,e),i.prototype.tagName="thead",i.prototype.events={"click .sorting":"sort"},i.prototype.refreshView=function(e){var t,n,i,s,o;s=this.$el.find("th"),o=[];for(n=0,i=s.length;n<i;n++)t=s[n],t=r(t),t.hasClass("sorting")?(t.removeClass("sorting-asc sorting-desc"),e[f.sort]?(this.sortConfiguration=e[f.sort],this.sortConfiguration[t.index()]?this.sortConfiguration[t.index()]===f.asc?o.push(t.addClass("sorting-asc")):o.push(t.addClass("sorting-desc")):o.push(void 0)):o.push(void 0)):o.push(void 0);return o},i.prototype.sort=function(e){var t;return t=r(e.target).index(),this.sortConfiguration||(this.sortConfiguration={}),e.shiftKey||(this.sortConfiguration[t]?this.sortConfiguration=n.pick(this.sortConfiguration,t):this.sortConfiguration={}),this.sortConfiguration[t]===void 0?this.sortConfiguration[t]=f.asc:this.sortConfiguration[t]===f.asc?this.sortConfiguration[t]=f.desc:this.sortConfiguration[t]=void 0,this.update(n.object([f.sort],[this.sortConfiguration]))},i.prototype.columns=function(){return this.$el.find("th").length},Dg.TableView=t.CompositeView.extend({template:c.table,itemViewContainer:"tbody",emptyView:Dg.EmptyView,itemViewOptions:function(e){return{vent:this.vent,columns:this.columns()}},initialize:function(e){return this.vent=e.vent,this.collection=e.collection},render:function(){var e;return this.resetItemViewContainer(),this.setElement(this.renderModel()),this.headerView&&(this.header=new this.headerView({vent:this.vent}),e=this.header.render().el,this.$el.prepend(e)),this.bindUIElements(),this.trigger("composite:model:rendered"),this.trigger("render"),this.renderCollection(),this.trigger("composite:rendered"),this},beforeClose:function(){if(this.header)return this.header.close()},columns:function(){return this.header?this.header.columns():0}}),i}(Dg.ItemView),Dg.TableRegion=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t}(t.Region),Dg.GridLayout=function(e){function r(){return this.handleRefresh=__bind(this.handleRefresh,this),this.handleUpdate=__bind(this.handleUpdate,this),this.refreshGrid=__bind(this.refreshGrid,this),this.renderRegions=__bind(this.renderRegions,this),r.__super__.constructor.apply(this,arguments)}return __extends(r,e),r.prototype.template=c.grid,r.prototype.initialize=function(e){return this.vent=new t.EventAggregator,this.on("render",this.renderRegions),this.vent.on("update",this.handleUpdate),this.vent.on("refresh",this.handleRefresh),this.vent.on("row:edit",this.handleEditModel),this.collection.on("fetched",this.refreshGrid)},r.prototype.renderRegions=function(){var e,t,r;r=this.regions;for(t in r)e=r[t],t!=="table"&&this[t].show(new e.view(n.extend({vent:this.vent},e.options||{})));return this.table.show(new s),this.collection.fetch()},r.prototype.refreshGrid=function(){return this.table.show(new this.regions.table.view({vent:this.vent,collection:this.collection})),this.vent.trigger("view:refresh",this.collection.getInfo())},r.prototype.handleUpdate=function(e){return this.table.show(new s),this.collection.updateInfo(e)},r.prototype.handleRefresh=function(){return this.collection.refresh()},r.prototype.handleEditModel=function(e){return alert(e.get("name"))},r.prototype.close=function(){return this.collection.off("fetched",this.refreshGrid),r.__super__.close.apply(this,arguments)},r}(t.Layout),Dg.createRowView=function(e,t){return Dg.RowView.extend({template:t,model:e})},Dg.createTableHeaderView=function(e){return Dg.HeaderView.extend({template:e})},Dg.createDefaultLayout=function(e){var t,r;return r=e.gridRegions||{},r=l(o(r,u),function(e,t,r){return!n.isObject(r)}),e.collection===void 0?t=Dg.GridLayout.extend({regions:r}):t=Dg.GridLayout.extend({collection:e.collection,regions:r}),t},a={info:"datagrid.info",pager:{first:"datagrid.pager.first",last:"datagrid.pager.last",next:"datagrid.pager.next",previous:"datagrid.pager.previous",filler:"datagrid.pager.filler"}},f={from:"from",to:"to",items:"items",totalItems:"totalItems",perPage:"perPage",pages:"pages",page:"page",term:"term",sort:"sort",asc:"A",desc:"D"},u={table:{selector:".dgTable",regionType:Dg.TableRegion,view:Dg.TableView},toolbar:{selector:".dgToolbar",view:Dg.ToolbarView},quickSearch:{selector:".dgQuickSearch",view:Dg.QuickSearchView},perPage:{selector:".dgPerPage",view:Dg.PerPageView},info:{selector:".dgInfo",view:Dg.InfoView},pager:{selector:".dgPager",view:Dg.PagerView}},Dg.setupDefaultI18nBindings=function(e){return a=n.defaults(e.i18n||{},a)},Dg.setupDefaultInfoBindings=function(e){return f=n.defaults(e.bindings||{},f)},Dg.setupDefaultGridLayout=function(e){return u=o(e.gridRegions||{},u)},Dg}(Backbone,Backbone.Marionette,_,$||window.jQuery||window.Zepto||window.ender);