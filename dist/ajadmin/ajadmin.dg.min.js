/*!
 * Ajadmin.Dg v0.0.1
 * Copyright (c) 2012 Laurent Pr√©vost (prevole) <prevole@prevole.ch>
 * Distributed under MIT license
 * https://github.com/prevole/ajadmin.dg
 */
(function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},n=function(e,t){return function(){return e.apply(t,arguments)}};Backbone.Ajadmin.Dg=window.Ajadmin.Dg=function(e,r,i,s){var o,u,a,f,l,c,h,p;return o=Ajadmin.Dg={version:"0.0.1"},f=function(e,t){var n,r;e===void 0&&(e={});for(n in t)r=t[n],e[n]===void 0||e[n]===null?e[n]=t[n]:i.isObject(t[n])&&i.isObject(e[n])&&(e[n]=f(e[n],t[n]));return e},p=function(e,t){var n,r,i;r={};for(n in e)i=e[n],t(e,n,i)||(r[n]=i);return r},o.ItemView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.initialize=function(e){if(!e.vent)throw new Error("No event aggregator given.");return this.vent=e.vent,this.vent.on("view:refresh",this.refreshView,this)},n.prototype.render=function(){return n.__super__.render.apply(this,arguments),this.vent.trigger("item:rendered",this),this},n.prototype.refreshView=function(e){throw new Error("The method refreshView(info) must be defined.")},n.prototype.update=function(e){return this.vent.trigger("update",e)},n.prototype.close=function(){return this.vent.off("view:refresh",this.refreshView),n.__super__.close.apply(this,arguments)},n}(r.ItemView),o.DefaultItemView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.render=function(){return this.beforeRender&&this.beforeRender(),this.trigger("before:render",this),this.trigger("item:before:render",this),this.setElement(s(r.Renderer.render(this.getTemplate(),this.serializeData())),!0),this.bindUIElements(),this.onRender&&this.onRender(),this.trigger("render",this),this.trigger("item:rendered",this),this.vent.trigger("item:rendered",this),this},n}(o.ItemView),o.InfoView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.template="layouts/dg/info",n.prototype.refreshView=function(e){return I18n?this.$el.text(I18n.t(c.info,{from:e[h.from],to:e[h.to],total:e[h.items]})):this.$el.text("Showing "+e[h.from]+" to "+e[h.to]+" of "+e[h.items]+" entries")},n}(o.DefaultItemView),o.QuickSearchView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.template="layouts/dg/quicksearch",n.prototype.events={"keyup input":"search"},n.prototype.ui={term:"input"},n.prototype.initialize=function(e){var t=this;return n.__super__.initialize.call(this,e),this.searchInternal=i.debounce(function(e){return t.update(i.object([h.term],[t.ui.term.val().trim()]))},300)},n.prototype.refreshView=function(e){return this.ui.term.val(e[h.term])},n.prototype.search=function(e){return this.searchInternal(e)},n}(o.DefaultItemView),o.PerPageView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.template="layouts/dg/perpage",n.prototype.events={"change .per-page":"perPage"},n.prototype.ui={perPage:".per-page"},n.prototype.refreshView=function(e){return this.ui.perPage.val(e[h.perPage])},n.prototype.perPage=function(e){return this.update(i.object([h.perPage],[this.ui.perPage.val()]))},n}(o.DefaultItemView),o.ToolbarView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.template="layouts/dg/toolbar",n.prototype.events={"click .refresh":"refresh","click .create":"create"},n.prototype.ui={create:".create",refresh:".refresh"},n.prototype.refreshView=function(e){return this.ui.refresh.removeClass("disabled"),this.ui.create.removeClass("disabled")},n.prototype.create=function(e){e.preventDefault();if(!this.ui.create.hasClass("disabled"))return this.ui.create.addClass("disabled")},n.prototype.refresh=function(e){e.preventDefault();if(!this.ui.refresh.hasClass("disabled"))return this.ui.refresh.addClass("disabled"),this.update({})},n}(o.DefaultItemView),o.PagerView=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}var n;return t(r,e),r.prototype.template="layouts/dg/pager",r.prototype.events={"click a":"pagging"},r.prototype.initialize=function(e){return r.__super__.initialize.call(this,e),this.deltaPage=e.deltaPage||2,this.css=i.defaults(e.css||{},{active:"active",disabled:"disabled",page:"page"}),I18n?this.texts=i.defaults(e.texts||{},{first:I18n.t(c.pager.first),previous:I18n.t(c.pager.previous),next:I18n.t(c.pager.next),last:I18n.t(c.pager.last),filler:I18n.t(c.pager.filler)}):this.texts=i.defaults(e.texts||{},{first:"<<",previous:"<",next:">",last:">>",filler:"..."}),this.numbers=!0,e.numbers!==void 0&&(this.numbers=e.numbers),this.firstAndLast=!0,e.firstAndLast!==void 0&&(this.firstAndLast=e.firstAndLast),this.previousAndNext=!0,e.previousAndNext!==void 0&&(this.previousAndNext=e.previousAndNext),this.info={},this.info[h.page]=0,this.info[h.pages]=0},r.prototype.refreshView=function(e){var t,r,i,o,u,a,f,l;this.info=e,this.$el.empty().hide(),f=s("<ul />"),o=this.info[h.page],u=this.info[h.pages];if(o>0&&u>1){i=o-this.deltaPage,r=o+this.deltaPage,i<=0&&(i=1),r>=u&&(r=u),a=o===1?this.css.disabled:"",this.firstAndLast&&f.append(n.call(this,this.texts.first,"f",a)),this.previousAndNext&&f.append(n.call(this,this.texts.previous,"p",a));if(this.numbers){i>1&&f.append(n.call(this,this.texts.filler,"",this.css.disabled));for(t=l=i;i<=r?l<=r:l>=r;t=i<=r?++l:--l)f.append(n.call(this,""+t,"page",t===o?this.css.active:""));r<u&&f.append(n.call(this,this.texts.filler,"",this.css.disabled))}return a=o===u?this.css.disabled:"",this.previousAndNext&&f.append(n.call(this,this.texts.next,"n",a)),this.firstAndLast&&f.append(n.call(this,this.texts.last,"l",a)),this.$el.append(f).show()}},r.prototype.pagging=function(e){var t,n,r;e.preventDefault(),n=s(e.target);if(!n.parent().hasClass(this.css.disabled)&&!n.parent().hasClass(this.css.active)){r=n.data("type");switch(r){case"f":t=1;break;case"p":t=this.info[h.page]-1>0?this.info[h.page]-1:this.info[h.page];break;case"n":t=this.info[h.page]+1<this.info[h.pages]?this.info[h.page]+1:this.info[h.pages];break;case"l":t=this.info[h.pages];break;default:t=parseInt(s(e.target).text())}if(t!==this.info[h.page])return this.update(i.object([h.page],[t]))}},n=function(e,t,n){var r,i;return r=s("<a/>").attr("href","#").data("type",t).addClass(this.css.page).html(""+e),i=s("<li />").html(r),n&&i.addClass(n),i},r}(o.DefaultItemView),o.RowView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.tagName="tr",n.prototype.events={"click .edit":"edit","click .delete":"delete"},n.prototype.initialize=function(e){return n.__super__.initialize.call(this,e),this.css=i.defaults(e.css||{},{asc:"sorting-asc",desc:"sorting-desc"}),this.cellTagName=e.cellTagName||"td"},n.prototype.refreshView=function(e){var t,n,r,i,o;if(e[h.sort]){i=this.$el.find(this.cellTagName),o=[];for(n=0,r=i.length;n<r;n++)t=i[n],t=s(t),t.removeClass(""+this.css.asc+" "+this.css.desc),this.css.none&&t.removeClass(this.css.none),e[h.sort][t.index()]?e[h.sort][t.index()]===h.asc?o.push(t.addClass(this.css.asc)):o.push(t.addClass(this.css.desc)):this.css.none?o.push(t.addClass(this.css.none)):o.push(void 0);return o}},n.prototype.edit=function(e){return e.preventDefault(),this.vent.trigger("row:edit",this.model)},n.prototype["delete"]=function(e){return e.preventDefault()},n.vent.trigger("row:delete",n.model),n}(o.TableItemView),u=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.template="layouts/dg/empty",n.prototype.ui={empty:".empty"},n.prototype.initialize=function(e){return this.columns=e.columns,n.__super__.initialize.call(this,e)},n.prototype.onRender=function(){return this.$el.attr("colspan",this.columns)},n.prototype.refreshView=function(e){},n}(o.DefaultItemView),a=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.template="layouts/dg/gridempty",n}(e.Marionette.ItemView),o.HeaderView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.events={"click .sorting":"sort"},n.prototype.refreshView=function(e){var t,n,r,i,o;i=this.$el.find("th"),o=[];for(n=0,r=i.length;n<r;n++)t=i[n],t=s(t),t.hasClass("sorting")?(t.removeClass("sorting-asc sorting-desc"),e[h.sort]?(this.sortConfiguration=e[h.sort],this.sortConfiguration[t.index()]?this.sortConfiguration[t.index()]===h.asc?o.push(t.addClass("sorting-asc")):o.push(t.addClass("sorting-desc")):o.push(void 0)):o.push(void 0)):o.push(void 0);return o},n.prototype.sort=function(e){var t;return t=s(e.target).index(),this.sortConfiguration||(this.sortConfiguration={}),e.shiftKey||(this.sortConfiguration[t]?this.sortConfiguration=i.pick(this.sortConfiguration,t):this.sortConfiguration={}),this.sortConfiguration[t]===void 0?this.sortConfiguration[t]=h.asc:this.sortConfiguration[t]===h.asc?this.sortConfiguration[t]=h.desc:this.sortConfiguration[t]=void 0,this.update(i.object([h.sort],[this.sortConfiguration]))},n.prototype.columns=function(){return this.$el.find("th").length},o.TableView=r.CompositeView.extend({template:"layouts/dg/table",itemViewContainer:"tbody",emptyView:DefaultTableEmptyView,itemViewOptions:function(e){return{vent:this.vent,columns:this.columns()}},initialize:function(e){return this.vent=e.vent,this.collection=e.collection},render:function(){var e;return this.resetItemViewContainer(),this.setElement(this.renderModel()),this.headerView&&(this.header=new this.headerView({vent:this.vent}),e=this.header.render().el,this.$el.prepend(e)),this.bindUIElements(),this.trigger("composite:model:rendered"),this.trigger("render"),this.renderCollection(),this.trigger("composite:rendered"),this},beforeClose:function(){if(this.header)return this.header.close()},columns:function(){return this.header?this.header.columns():0}}),n}(o.DefaultItemView),o.TableRegion=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n}(r.Region),o.GridLayout=function(e){function s(){return this.handleRefresh=n(this.handleRefresh,this),this.handleUpdate=n(this.handleUpdate,this),this.refreshGrid=n(this.refreshGrid,this),this.renderRegions=n(this.renderRegions,this),s.__super__.constructor.apply(this,arguments)}return t(s,e),s.prototype.template="layouts/dg/grid",s.prototype.initialize=function(e){return this.vent=new r.EventAggregator,this.on("render",this.renderRegions),this.vent.on("update",this.handleUpdate),this.vent.on("refresh",this.handleRefresh),this.vent.on("row:edit",this.handleEditModel),this.collection.on("fetched",this.refreshGrid)},s.prototype.renderRegions=function(){var e,t,n;n=this.regions;for(t in n)e=n[t],t!=="table"&&this[t].show(new e.view(i.extend({vent:this.vent},e.options||{})));return this.table.show(new DefaultGridEmptyView),this.collection.fetch()},s.prototype.refreshGrid=function(){return this.table.show(new this.regions.table.view({vent:this.vent,collection:this.collection})),this.vent.trigger("view:refresh",this.collection.getInfo())},s.prototype.handleUpdate=function(e){return this.table.show(new DefaultGridEmptyView),this.collection.updateInfo(e)},s.prototype.handleRefresh=function(){return this.collection.refresh()},s.prototype.handleEditModel=function(e){return alert(e.get("name"))},s.prototype.close=function(){return this.collection.off("fetched",this.refreshGrid),s.__super__.close.apply(this,arguments)},s}(r.Layout),o.createRowView=function(e,t){return o.RowView.extend({template:t,model:e})},o.createTableHeaderView=function(e){return o.HeaderView.extend({template:e})},o.createDefaultLayout=function(e){var t,n;return n=e.gridRegions||{},n=p(f(n,l),function(e,t,n){return!i.isObject(n)}),e.collection===void 0?t=o.GridLayout.extend({regions:n}):t=o.GridLayout.extend({collection:e.collection,regions:n}),t},c={info:"datagrid.info",pager:{first:"datagrid.pager.first",last:"datagrid.pager.last",next:"datagrid.pager.next",previous:"datagrid.pager.previous",filler:"datagrid.pager.filler"}},h={from:"from",to:"to",items:"items",totalItems:"totalItems",perPage:"perPage",pages:"pages",page:"page",term:"term",sort:"sort",asc:"A",desc:"D"},l={table:{selector:".dgTable",regionType:o.TableRegion,view:o.TableView},toolbar:{selector:".dgToolbar",view:o.ToolbarView},quickSearch:{selector:".dgQuickSearch",view:o.QuickSearchView},perPage:{selector:".dgPerPage",view:o.PerPageView},info:{selector:".dgInfo",view:o.InfoView},pager:{selector:".dgPager",view:o.PagerView}},o.setupDefaultI18nBindings=function(e){return c=i.defaults(e.i18n||{},c)},o.setupDefaultInfoBindings=function(e){return h=i.defaults(e.bindings||{},h)},o.setupDefaultGridLayout=function(e){return l=f(e.gridRegions||{},l)},o}(Backbone,Backbone.Marionette,_,$||window.jQuery||window.Zepto||window.ender)}).call(this);