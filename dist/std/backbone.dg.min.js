/*
 * Backbone.Dg - v0.0.1
 * Copyright (c) 2014-03-08 Laurent Pr√©vost (Prevole) <prevole@prevole.ch>
 * Distributed under MIT license
 * https://github.com/prevole/backbone.dg
 */
(function(){var a={}.hasOwnProperty,b=function(b,c){function d(){this.constructor=b}for(var e in c)a.call(c,e)&&(b[e]=c[e]);return d.prototype=c.prototype,b.prototype=new d,b.__super__=c.prototype,b};window.Backbone.Dg=window.Dg=function(Backbone,a,c,d){var e,f,g,h,i,j,k,l,m,n,o;return e={version:"0.1.0"},i={info:"datagrid.info",nodata:"datagrid.nodata",loading:"datagrid.loading",perpage:"datagrid.perpage",quicksearch:"datagrid.quicksearch",pager:{first:"datagrid.pager.first",last:"datagrid.pager.last",next:"datagrid.pager.next",previous:"datagrid.pager.previous",filler:"datagrid.pager.filler"}},g=function(a,b){var d,e;void 0===a&&(a={});for(d in b)e=b[d],void 0===a[d]||null===a[d]?a[d]=b[d]:c.isObject(b[d])&&c.isObject(a[d])&&(a[d]=g(a[d],b[d]));return a},m=function(a,b){var c,d,e;d={};for(c in a)e=a[c],b(a,c,e)||(d[c]=e);return d},l=function(a,b){var d,e,f;if(!a||!c.isObject(a))return!1;for(e=0,f=b.length;f>e;e++)if(d=b[e],void 0===a[d])return!1;return!0},k=function(){return!(void 0===window.I18n)},n=Function.prototype.call.bind(Array.prototype.slice),o={empty:function(){var a;return a="No data",k()&&(a=I18n.t(i.nodata)),"<td class='empty'>"+a+"</td>"},grid:function(){return'<div class="dgGrid"><div class="clearfix"><div class="dgPerPage" /><div class="dgToolbar" /><div class="dgQuickSearch" /></div><div class="dgTable" /><div class="clearfix"><div class="dgInfo pull-left" /><div class="dgPager pull-right" /></div></div>'},gridempty:function(){var a;return a="Loading data",k()&&(a=I18n.t(i.loading)),'<div class="dgLoading"><div class="progress progress-striped active">'+("<div class='bar' style='width:100%'>"+a+"</div>")+"</div></div>"},info:function(){return'<span class="info" />'},pager:function(){return"<div/>"},perpage:function(){var a;return a="Item per page:",k()&&(a=I18n.t(i.perpage)),'<div class="form-inline pull-left">'+("<label class='checkbox'>"+a+"&nbsp;</label>")+'<select class="per-page input-mini"><option>2</option><option>5</option><option>10</option><option>25</option><option>50</option><option>100</option></select></div>'},quicksearch:function(){var a;return a="Quick search:",k()&&(a=I18n.t(i.quicksearch)),'<div class="form-inline pull-right qs">'+("<label class='checkbox'>"+a+"&nbsp;</label>")+'<input type="text" class="form-control" /></div>'},table:function(){return'<table class="table table-striped table-hover table-condensed"><tbody/></table>'},toolbar:function(){return'<div class="form-inline pull-right buttons btn-group"><button class="btn refresh"><i class="glyphicon glyphicon-refresh" /></button><button class="btn create"><i class="glyphicon glyphicon-plus" /></button></div>'}},e.registerTemplate=function(a,b){return o[a]=b},e.getTemplate=function(a){if(!o[a])throw new Error("Unknown template");return o[a]},e.ItemView=a.ItemView.extend({constructor:function(){if(a.ItemView.prototype.constructor.apply(this,arguments),c.extend(this,c.pick(this.options,c.union(this.optionNames||[],["vent"]))),!this.vent)throw new Error("No event aggregator given.");return this.vent.on("view:refresh",this.refreshView,this),this},onRender:function(){return this.vent.trigger("item:rendered",this)},refreshView:function(){throw new Error("The method refreshView(info) must be defined.")},update:function(a){return this.vent.trigger("update",a)},onClose:function(){return this.vent.off("view:refresh",this.refreshView,this)}}),e.DefaultItemView=e.ItemView.extend({constructor:function(){return e.ItemView.prototype.constructor.apply(this,arguments)},render:function(){return this.beforeRender&&this.beforeRender(),this.trigger("before:render",this),this.trigger("item:before:render",this),this.setElement(d(a.Renderer.render(this.getTemplate(),this.serializeData())),!0),this.bindUIElements(),this.onRender(),this.trigger("render",this),this.trigger("item:rendered",this),this.vent.trigger("item:rendered",this),this}}),e.InfoView=e.DefaultItemView.extend({template:o.info,refreshView:function(a){return this.$el.text(k()?I18n.t(i.info,{from:a[j.from],to:a[j.to],total:a[j.items]}):"Showing "+a[j.from]+" to "+a[j.to]+" of "+a[j.items]+" entries")}}),e.QuickSearchView=e.DefaultItemView.extend({template:o.quicksearch,events:{"keyup input":"search"},ui:{term:"input"},_searchInternal:c.debounce(function(){return this.update(c.object([j.term],[this.ui.term.val().trim()]))},300),refreshView:function(a){return this.ui.term.val(a[j.term])},search:function(a){return this._searchInternal(a)}}),e.PerPageView=e.DefaultItemView.extend({template:o.perpage,events:{"change .per-page":"perPage"},ui:{perPage:".per-page"},refreshView:function(a){return this.ui.perPage.val(a[j.perPage])},perPage:function(){return this.update(c.object([j.perPage],[parseInt(this.ui.perPage.val())]))}}),e.ToolbarView=function(a){function c(){return c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.template=o.toolbar,c.prototype.events={"click .refresh":"refresh","click .create":"create"},c.prototype.ui={create:".create",refresh:".refresh"},c.prototype.refreshView=function(){return this.ui.refresh.removeClass("disabled"),this.ui.create.removeClass("disabled")},c.prototype.create=function(a){return a.preventDefault(),this.ui.create.hasClass("disabled")||this.ui.create.addClass("disabled"),this.vent.trigger("create:model")},c.prototype.refresh=function(a){return a.preventDefault(),this.ui.refresh.hasClass("disabled")?void 0:(this.ui.refresh.addClass("disabled"),this.update({}))},c}(e.DefaultItemView),e.PagerView=e.DefaultItemView.extend({optionNames:["deltaPage","css","texts","numbers","firstAndLast","previousAndNext"],template:o.pager,events:{"click a":"pagging"},deltaPage:2,numbers:!0,firstAndLast:!0,previousAndNext:!0,css:{active:"active",disabled:"disabled",page:"page"},texts:function(){return k()?{first:I18n.t(i.pager.first),previous:I18n.t(i.pager.previous),next:I18n.t(i.pager.next),last:I18n.t(i.pager.last),filler:I18n.t(i.pager.filler)}:{first:"<<",previous:"<",next:">",last:">>",filler:"..."}},constructor:function(){return e.DefaultItemView.prototype.constructor.apply(this,n(arguments)),this.info={},this.info[j.page]=0,this.info[j.pages]=0},refreshView:function(a){var b,e,f,g,h,i,k,l,m,n;if(this.info=a,this.$el.empty().hide(),m=d('<ul class="pagination pagination-right" />'),i=this.info[j.page],k=this.info[j.pages],i>0&&k>1){if(f=c.result(this,"texts"),h=i-this.deltaPage,g=i+this.deltaPage,0>=h&&(h=1),g>=k&&(g=k),l=1===i?this.css.disabled:"",this.firstAndLast&&m.append(this._createLink(f.first,"f",l)),this.previousAndNext&&m.append(this._createLink(f.previous,"p",l)),this.numbers){for(h>1&&m.append(this._createLink(f.filler,"",this.css.disabled)),e=n=h;g>=h?g>=n:n>=g;e=g>=h?++n:--n)b=e===i?this.css.active:"",m.append(this._createLink(""+e,"page",b));k>g&&m.append(this._createLink(f.filler,"",this.css.disabled))}return l=i===k?this.css.disabled:"",this.previousAndNext&&m.append(this._createLink(f.next,"n",l)),this.firstAndLast&&m.append(this._createLink(f.last,"l",l)),this.$el.append(m).show()}},pagging:function(a){var b,e,f;if(a.preventDefault(),e=d(a.target),!e.parent().hasClass(this.css.disabled)&&!e.parent().hasClass(this.css.active)){switch(f=e.data("type")){case"f":b=1;break;case"p":b=this.info[j.page]-1>0?this.info[j.page]-1:this.info[j.page];break;case"n":b=this.info[j.page]+1<this.info[j.pages]?this.info[j.page]+1:this.info[j.pages];break;case"l":b=this.info[j.pages];break;default:b=parseInt(d(a.target).text())}if(b!==this.info[j.page])return this.update(c.object([j.page],[b]))}},_createLink:function(a,b,c){var e,f;return e=d("<a/>").attr("href","#").data("type",b).addClass(this.css.page).html(""+a),f=d("<li />").html(e),c&&f.addClass(c),f}}),e.RowView=e.ItemView.extend({optionNames:["css","cellTagName"],tagName:"tr",events:{"click .edit":"edit","click .delete":"delete"},css:{asc:"sorting-asc",desc:"sorting-desc",none:null},cellTagName:"td",refreshView:function(a){var b,c,e,f,g;if(a[j.sort]){for(f=this.$el.find(this.cellTagName),g=[],c=0,e=f.length;e>c;c++)b=f[c],b=d(b),b.removeClass(""+this.css.asc+" "+this.css.desc),this.css.none&&b.removeClass(this.css.none),g.push(a[j.sort][b.index()]?a[j.sort][b.index()]===j.asc?b.addClass(this.css.asc):b.addClass(this.css.desc):this.css.none?b.addClass(this.css.none):void 0);return g}},edit:function(a){return a.preventDefault(),this.vent.trigger("row:edit",this.model)},"delete":function(a){return a.preventDefault(),this.vent.trigger("row:delete",this.model)}}),e.EmptyView=e.DefaultItemView.extend({optionNames:["columns"],template:o.empty,ui:{empty:".empty"},onRender:function(){return this.$el.attr("colspan",this.columns)},refreshView:function(){}}),f=Backbone.Marionette.ItemView.extend({template:o.gridempty}),e.HeaderView=e.ItemView.extend({optionNames:["parentSelector","appendMode","columnTag","sortTag","css"],tagName:"thead",parentSelector:"table",appendMode:"prepend",columnTag:"th",sortTag:"th",css:{sortable:"sorting",asc:"sorting-asc",desc:"sorting-desc",none:"sorting-none"},events:{"click .sorting":"sort"},refreshView:function(a){var b,c,e,f,g,h;for(g=this.$el.find(""+this.sortTag+"."+this.css.sortable),h=[],e=0,f=g.length;f>e;e++)c=g[e],b=d(c),b.removeClass(""+this.css.asc+" "+this.css.desc+" "+this.css.none),a[j.sort]?(this.sortConfiguration=a[j.sort],h.push(this.sortConfiguration[b.index()]?this.sortConfiguration[b.index()]===j.asc?b.addClass(this.css.asc):b.addClass(this.css.desc):b.addClass(this.css.none))):h.push(void 0);return h},sort:function(a){var b;return b=d("."+this.css.sortable,this.$el).index(d(a.target)),this.sortConfiguration||(this.sortConfiguration={}),a.shiftKey||(this.sortConfiguration=this.sortConfiguration[b]?c.pick(this.sortConfiguration,b):{}),this.sortConfiguration[b]=void 0===this.sortConfiguration[b]?j.asc:this.sortConfiguration[b]===j.asc?j.desc:void 0,this.update(c.object([j.sort],[this.sortConfiguration]))},columns:function(){return this.$el.find(this.columnTag).length}}),e.TableView=a.CompositeView.extend({template:o.table,itemViewContainer:"tbody",emptyView:e.EmptyView,itemViewOptions:function(){return{vent:this.vent,columns:this.columns()}},constructor:function(){return a.CompositeView.prototype.constructor.apply(this,n(arguments)),c.extend(this,c.pick(this.options,"vent"))},onCompositeModelRendered:function(){var a;return this.headerView&&(this.header=new this.headerView(this.options),a=void 0===this.header.parentSelector||""===this.header.parentSelector?"table":this.header.parentSelector,void 0===this.header.appendMode||"prepend"!==this.header.appendMode?this.$el.find(a).append(this.header.render().el):this.$el.find(a).prepend(this.header.render().el)),this.trigger("render")},beforeClose:function(){return this.header?this.header.close():void 0},columns:function(){return this.header?this.header.columns():0}}),e.TableRegion=a.Region.extend,e.GridLayout=a.Layout.extend({template:o.grid,constructor:function(){return this.vent=new Backbone.Wreqr.EventAggregator,a.Layout.prototype.constructor.apply(this,n(arguments)),this.on("render",this.renderRegions),this.listenTo(this.vent,"update",this.handleUpdate),this.listenTo(this.vent,"refresh",this.handleRefresh),this.listenTo(this.vent,"row:edit",this.handleEdit),this.listenTo(this.vent,"row:delete",this.handleDelete),this.listenTo(this.vent,"create:model",this.handleCreate),this.listenTo(this.collection,"fetched",this.refreshGrid),this.listenTo(this.collection,"info:updated",this.refreshGrid)},renderRegions:function(){var a,b,d,e;e=this.regions;for(d in e)b=e[d],"table"!==d&&(a=c.extend({vent:this.vent},b.options||{}),this[d].show(new b.view(c.extend(a,this.options))));return this.table.show(new f),this.collection.fetch()},refreshGrid:function(){return this.table.show(new this.regions.table.view(c.extend({vent:this.vent,collection:this.collection},this.options))),this.refreshInfo()},refreshInfo:function(){return this.vent.trigger("view:refresh",this.collection.getInfo())},handleUpdate:function(a){return this.table.show(new f),this.collection.updateInfo(a)},handleRefresh:function(){return this.collection.refresh()},handleEdit:function(a){return this.trigger("edit",a)},handleDelete:function(a){return this.trigger("delete",a)},handleCreate:function(){return this.trigger("new")},onClose:function(){return this.collection.off("fetched",this.refreshGrid)}}),e.createRowView=function(a){if(!l(a,["template","model"]))throw new Error("template or model is missing in the options");return e.RowView.extend(a)},e.createHeaderView=function(a){if(!l(a,["template"]))throw new Error("template is missing in the options");return e.HeaderView.extend(a)},e.createTableView=function(a){if(!l(a,["template","itemViewContainer","itemView"]))throw new Error("template, itemViewContainer or itemView is missing in the options");return e.TableView.extend(a)},e.createGridLayout=function(a){var b,d;return a=a||{},d=a.gridRegions||{},d=m(g(d,h),function(a,b,d){return!c.isObject(d)}),b=e.GridLayout.extend(void 0===a.collection?{regions:d}:{collection:a.collection,regions:d}),void 0!==a.template&&(b.prototype.template=o[a.template]),b},j={from:"from",to:"to",items:"items",totalItems:"totalItems",perPage:"perPage",pages:"pages",page:"page",term:"term",sort:"sort",asc:"A",desc:"D"},h={table:{selector:".dgTable",view:e.TableView},toolbar:{selector:".dgToolbar",view:e.ToolbarView},quickSearch:{selector:".dgQuickSearch",view:e.QuickSearchView},perPage:{selector:".dgPerPage",view:e.PerPageView},info:{selector:".dgInfo",view:e.InfoView},pager:{selector:".dgPager",view:e.PagerView}},e.setupDefaultI18nBindings=function(a){return e.i18nKeys=c.defaults(a.i18n||{},e.i18nKeys)},e.setupDefaultInfoBindings=function(a){return j=c.defaults(a.bindings||{},j)},e.setupDefaultGridLayout=function(a){return h=g(a.gridRegions||{},h)},e}(Backbone,Backbone.Marionette,_,$||window.jQuery||window.Zepto||window.ender)}).call(this);