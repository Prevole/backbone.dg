/*
 * Backbone.Dg - version: 0.1.25
 * Copyright (c) 2014-03-07 Laurent Pr√©vost (Prevole) <prevole@prevole.ch>
 * Distributed under MIT license
 * https://github.com/prevole/backbone.dg
 */
(function(){var e={}.hasOwnProperty,t=function(t,i){function r(){this.constructor=t}for(var n in i)e.call(i,n)&&(t[n]=i[n]);return r.prototype=i.prototype,t.prototype=new r,t.__super__=i.prototype,t};window.Backbone.Dg=window.Dg=function(Backbone,e,i,r){var n,s,o,a,d,h,l,c,u,p,f;return n={version:"0.1.25"},d={info:"datagrid.info",nodata:"datagrid.nodata",loading:"datagrid.loading",perpage:"datagrid.perpage",quicksearch:"datagrid.quicksearch",pager:{first:"datagrid.pager.first",last:"datagrid.pager.last",next:"datagrid.pager.next",previous:"datagrid.pager.previous",filler:"datagrid.pager.filler"}},o=function(e,t){var r,n;void 0===e&&(e={});for(r in t)n=t[r],void 0===e[r]||null===e[r]?e[r]=t[r]:i.isObject(t[r])&&i.isObject(e[r])&&(e[r]=o(e[r],t[r]));return e},u=function(e,t){var i,r,n;r={};for(i in e)n=e[i],t(e,i,n)||(r[i]=n);return r},c=function(e,t){var r,n,s;if(!e||!i.isObject(e))return!1;for(n=0,s=t.length;s>n;n++)if(r=t[n],void 0===e[r])return!1;return!0},l=function(){return!(void 0===window.I18n)},p=Function.prototype.call.bind(Array.prototype.slice),f={empty:function(){var e;return e="No data",l()&&(e=I18n.t(d.nodata)),"<td class='empty'>"+e+"</td>"},grid:function(){return'<div class="dgGrid"><div class="clearfix"><div class="dgPerPage" /><div class="dgToolbar" /><div class="dgQuickSearch" /></div><div class="dgTable" /><div class="clearfix"><div class="dgInfo pull-left" /><div class="dgPager pull-right" /></div></div>'},gridempty:function(){var e;return e="Loading data",l()&&(e=I18n.t(d.loading)),'<div class="dgLoading"><div class="progress progress-striped active">'+("<div class='bar' style='width:100%'>"+e+"</div>")+"</div>"+"</div>"},info:function(){return'<span class="info" />'},pager:function(){return"<div/>"},perpage:function(){var e;return e="Item per page:",l()&&(e=I18n.t(d.perpage)),'<div class="form-inline pull-left">'+("<label class='checkbox'>"+e+"&nbsp;</label>")+'<select class="per-page input-mini">'+"<option>2</option>"+"<option>5</option>"+"<option>10</option>"+"<option>25</option>"+"<option>50</option>"+"<option>100</option>"+"</select>"+"</div>"},quicksearch:function(){var e;return e="Quick search:",l()&&(e=I18n.t(d.quicksearch)),'<div class="form-inline pull-right qs">'+("<label class='checkbox'>"+e+"&nbsp;</label>")+'<input type="text" class="form-control" />'+"</div>"},table:function(){return'<table class="table table-striped table-hover table-condensed"><tbody/></table>'},toolbar:function(){return'<div class="form-inline pull-right buttons btn-group"><button class="btn refresh"><i class="glyphicon glyphicon-refresh" /></button><button class="btn create"><i class="glyphicon glyphicon-plus" /></button></div>'}},n.registerTemplate=function(e,t){return f[e]=t},n.getTemplate=function(e){if(!f[e])throw Error("Unknown template");return f[e]},n.ItemView=e.ItemView.extend({constructor:function(){if(e.ItemView.prototype.constructor.apply(this,p(arguments)),i.extend(this,i.pick(this.options,i.union(this.optionNames||[],["vent"]))),!this.vent)throw Error("No event aggregator given.");return this.vent.on("view:refresh",this.refreshView,this),this},onRender:function(){return this.vent.trigger("item:rendered",this)},refreshView:function(){throw Error("The method refreshView(info) must be defined.")},update:function(e){return this.vent.trigger("update",e)},onClose:function(){return this.vent.off("view:refresh",this.refreshView)}}),n.DefaultItemView=n.ItemView.extend({constructor:function(){return n.ItemView.prototype.constructor.apply(this,p(arguments))},render:function(){return this.beforeRender&&this.beforeRender(),this.trigger("before:render",this),this.trigger("item:before:render",this),this.setElement(r(e.Renderer.render(this.getTemplate(),this.serializeData())),!0),this.bindUIElements(),this.onRender&&this.onRender(),this.trigger("render",this),this.trigger("item:rendered",this),this.vent.trigger("item:rendered",this),this}}),n.InfoView=n.DefaultItemView.extend({template:f.info,refreshView:function(e){return l()?this.$el.text(I18n.t(d.info,{from:e[h.from],to:e[h.to],total:e[h.items]})):this.$el.text("Showing "+e[h.from]+" to "+e[h.to]+" of "+e[h.items]+" entries")}}),n.QuickSearchView=n.DefaultItemView.extend({template:f.quicksearch,events:{"keyup input":"search"},ui:{term:"input"},_searchInternal:i.debounce(function(){return this.update(i.object([h.term],[this.ui.term.val().trim()]))},300),refreshView:function(e){return this.ui.term.val(e[h.term])},search:function(e){return this._searchInternal(e)}}),n.PerPageView=n.DefaultItemView.extend({template:f.perpage,events:{"change .per-page":"perPage"},ui:{perPage:".per-page"},refreshView:function(e){return this.ui.perPage.val(e[h.perPage])},perPage:function(){return this.update(i.object([h.perPage],[parseInt(this.ui.perPage.val())]))}}),n.ToolbarView=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return t(i,e),i.prototype.template=f.toolbar,i.prototype.events={"click .refresh":"refresh","click .create":"create"},i.prototype.ui={create:".create",refresh:".refresh"},i.prototype.refreshView=function(){return this.ui.refresh.removeClass("disabled"),this.ui.create.removeClass("disabled")},i.prototype.create=function(e){return e.preventDefault(),this.ui.create.hasClass("disabled")||this.ui.create.addClass("disabled"),this.vent.trigger("create:model")},i.prototype.refresh=function(e){return e.preventDefault(),this.ui.refresh.hasClass("disabled")?void 0:(this.ui.refresh.addClass("disabled"),this.update({}))},i}(n.DefaultItemView),n.PagerView=n.DefaultItemView.extend({optionNames:["deltaPage","css","texts","numbers","firstAndLast","previousAndNext"],template:f.pager,events:{"click a":"pagging"},deltaPage:2,numbers:!0,firstAndLast:!0,previousAndNext:!0,css:{active:"active",disabled:"disabled",page:"page"},texts:function(){return l()?{first:I18n.t(d.pager.first),previous:I18n.t(d.pager.previous),next:I18n.t(d.pager.next),last:I18n.t(d.pager.last),filler:I18n.t(d.pager.filler)}:{first:"<<",previous:"<",next:">",last:">>",filler:"..."}},constructor:function(){return n.DefaultItemView.prototype.constructor.apply(this,p(arguments)),this.info={},this.info[h.page]=0,this.info[h.pages]=0},refreshView:function(e){var t,n,s,o,a,d,l,c,u,p;if(this.info=e,this.$el.empty().hide(),u=r('<ul class="pagination pagination-right" />'),d=this.info[h.page],l=this.info[h.pages],d>0&&l>1){if(s=i.result(this,"texts"),a=d-this.deltaPage,o=d+this.deltaPage,0>=a&&(a=1),o>=l&&(o=l),c=1===d?this.css.disabled:"",this.firstAndLast&&u.append(this._createLink(s.first,"f",c)),this.previousAndNext&&u.append(this._createLink(s.previous,"p",c)),this.numbers){for(a>1&&u.append(this._createLink(s.filler,"",this.css.disabled)),n=p=a;o>=a?o>=p:p>=o;n=o>=a?++p:--p)t=n===d?this.css.active:"",u.append(this._createLink(""+n,"page",t));l>o&&u.append(this._createLink(s.filler,"",this.css.disabled))}return c=d===l?this.css.disabled:"",this.previousAndNext&&u.append(this._createLink(s.next,"n",c)),this.firstAndLast&&u.append(this._createLink(s.last,"l",c)),this.$el.append(u).show()}},pagging:function(e){var t,n,s;if(e.preventDefault(),n=r(e.target),!n.parent().hasClass(this.css.disabled)&&!n.parent().hasClass(this.css.active)){switch(s=n.data("type")){case"f":t=1;break;case"p":t=this.info[h.page]-1>0?this.info[h.page]-1:this.info[h.page];break;case"n":t=this.info[h.page]+1<this.info[h.pages]?this.info[h.page]+1:this.info[h.pages];break;case"l":t=this.info[h.pages];break;default:t=parseInt(r(e.target).text())}if(t!==this.info[h.page])return this.update(i.object([h.page],[t]))}},_createLink:function(e,t,i){var n,s;return n=r("<a/>").attr("href","#").data("type",t).addClass(this.css.page).html(""+e),s=r("<li />").html(n),i&&s.addClass(i),s}}),n.RowView=n.ItemView.extend({optionNames:["css","cellTagName"],tagName:"tr",events:{"click .edit":"edit","click .delete":"delete"},css:{asc:"sorting-asc",desc:"sorting-desc",none:null},cellTagName:"td",refreshView:function(e){var t,i,n,s,o;if(e[h.sort]){for(s=this.$el.find(this.cellTagName),o=[],i=0,n=s.length;n>i;i++)t=s[i],t=r(t),t.removeClass(""+this.css.asc+" "+this.css.desc),this.css.none&&t.removeClass(this.css.none),e[h.sort][t.index()]?e[h.sort][t.index()]===h.asc?o.push(t.addClass(this.css.asc)):o.push(t.addClass(this.css.desc)):this.css.none?o.push(t.addClass(this.css.none)):o.push(void 0);return o}},edit:function(e){return e.preventDefault(),this.vent.trigger("row:edit",this.model)},"delete":function(e){return e.preventDefault(),this.vent.trigger("row:delete",this.model)}}),n.EmptyView=n.DefaultItemView.extend({optionNames:["columns"],template:f.empty,ui:{empty:".empty"},onRender:function(){return this.$el.attr("colspan",this.columns)},refreshView:function(){}}),s=Backbone.Marionette.ItemView.extend({template:f.gridempty}),n.HeaderView=n.ItemView.extend({optionNames:["parentSelector","appendMode","columnTag","sortTag","css"],tagName:"thead",parentSelector:"table",appendMode:"prepend",columnTag:"th",sortTag:"th",css:{sortable:"sorting",asc:"sorting-asc",desc:"sorting-desc",none:"sorting-none"},events:{"click .sorting":"sort"},refreshView:function(e){var t,i,n,s,o,a;for(o=this.$el.find(""+this.sortTag+"."+this.css.sortable),a=[],n=0,s=o.length;s>n;n++)i=o[n],t=r(i),t.removeClass(""+this.css.asc+" "+this.css.desc+" "+this.css.none),e[h.sort]?(this.sortConfiguration=e[h.sort],this.sortConfiguration[t.index()]?this.sortConfiguration[t.index()]===h.asc?a.push(t.addClass(this.css.asc)):a.push(t.addClass(this.css.desc)):a.push(t.addClass(this.css.none))):a.push(void 0);return a},sort:function(e){var t;return t=r("."+this.css.sortable,this.$el).index(r(e.target)),this.sortConfiguration||(this.sortConfiguration={}),e.shiftKey||(this.sortConfiguration=this.sortConfiguration[t]?i.pick(this.sortConfiguration,t):{}),this.sortConfiguration[t]=void 0===this.sortConfiguration[t]?h.asc:this.sortConfiguration[t]===h.asc?h.desc:void 0,this.update(i.object([h.sort],[this.sortConfiguration]))},columns:function(){return this.$el.find(this.columnTag).length}}),n.TableView=e.CompositeView.extend({template:f.table,itemViewContainer:"tbody",emptyView:n.EmptyView,itemViewOptions:function(){return{vent:this.vent,columns:this.columns()}},constructor:function(){return e.CompositeView.prototype.constructor.apply(this,p(arguments)),i.extend(this,i.pick(this.options,"vent"))},onCompositeModelRendered:function(){var e;return this.headerView&&(this.header=new this.headerView(this.options),e=void 0===this.header.parentSelector||""===this.header.parentSelector?"table":this.header.parentSelector,void 0===this.header.appendMode||"prepend"!==this.header.appendMode?this.$el.find(e).append(this.header.render().el):this.$el.find(e).prepend(this.header.render().el)),this.trigger("render")},beforeClose:function(){return this.header?this.header.close():void 0},columns:function(){return this.header?this.header.columns():0}}),n.TableRegion=e.Region.extend,n.GridLayout=e.Layout.extend({template:f.grid,constructor:function(){return this.vent=new Backbone.Wreqr.EventAggregator,e.Layout.prototype.constructor.apply(this,p(arguments)),this.on("render",this.renderRegions),this.listenTo(this.vent,"update",this.handleUpdate),this.listenTo(this.vent,"refresh",this.handleRefresh),this.listenTo(this.vent,"row:edit",this.handleEdit),this.listenTo(this.vent,"row:delete",this.handleDelete),this.listenTo(this.vent,"create:model",this.handleCreate),this.listenTo(this.collection,"fetched",this.refreshGrid),this.listenTo(this.collection,"info:updated",this.refreshGrid)},renderRegions:function(){var e,t,r,n;n=this.regions;for(r in n)t=n[r],"table"!==r&&(e=i.extend({vent:this.vent},t.options||{}),this[r].show(new t.view(i.extend(e,this.options))));return this.table.show(new s),this.collection.fetch()},refreshGrid:function(){return this.table.show(new this.regions.table.view(i.extend({vent:this.vent,collection:this.collection},this.options))),this.refreshInfo()},refreshInfo:function(){return this.vent.trigger("view:refresh",this.collection.getInfo())},handleUpdate:function(e){return this.table.show(new s),this.collection.updateInfo(e)},handleRefresh:function(){return this.collection.refresh()},handleEdit:function(e){return this.trigger("edit",e)},handleDelete:function(e){return this.trigger("delete",e)},handleCreate:function(){return this.trigger("new")},onClose:function(){return this.collection.off("fetched",this.refreshGrid)}}),n.createRowView=function(e){if(!c(e,["template","model"]))throw Error("template or model is missing in the options");return n.RowView.extend(e)},n.createHeaderView=function(e){if(!c(e,["template"]))throw Error("template is missing in the options");return n.HeaderView.extend(e)},n.createTableView=function(e){if(!c(e,["template","itemViewContainer","itemView"]))throw Error("template, itemViewContainer or itemView is missing in the options");return n.TableView.extend(e)},n.createGridLayout=function(e){var t,r;return e=e||{},r=e.gridRegions||{},r=u(o(r,a),function(e,t,r){return!i.isObject(r)}),t=void 0===e.collection?n.GridLayout.extend({regions:r}):n.GridLayout.extend({collection:e.collection,regions:r}),void 0!==e.template&&(t.prototype.template=f[e.template]),t},h={from:"from",to:"to",items:"items",totalItems:"totalItems",perPage:"perPage",pages:"pages",page:"page",term:"term",sort:"sort",asc:"A",desc:"D"},a={table:{selector:".dgTable",view:n.TableView},toolbar:{selector:".dgToolbar",view:n.ToolbarView},quickSearch:{selector:".dgQuickSearch",view:n.QuickSearchView},perPage:{selector:".dgPerPage",view:n.PerPageView},info:{selector:".dgInfo",view:n.InfoView},pager:{selector:".dgPager",view:n.PagerView}},n.setupDefaultI18nBindings=function(e){return n.i18nKeys=i.defaults(e.i18n||{},n.i18nKeys)},n.setupDefaultInfoBindings=function(e){return h=i.defaults(e.bindings||{},h)},n.setupDefaultGridLayout=function(e){return a=o(e.gridRegions||{},a)},n}(Backbone,Backbone.Marionette,_,$||window.jQuery||window.Zepto||window.ender)}).call(this);