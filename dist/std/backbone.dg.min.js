/*
 * Backbone.Dg - v0.0.1
 * Copyright (c) 2014-03-28 Laurent Pr√©vost (Prevole) <prevole@prevole.ch>
 * Distributed under MIT license
 * https://github.com/prevole/backbone.dg
 */
(function(){var a={}.hasOwnProperty,b=function(b,c){function d(){this.constructor=b}for(var e in c)a.call(c,e)&&(b[e]=c[e]);return d.prototype=c.prototype,b.prototype=new d,b.__super__=c.prototype,b};window.Backbone.Dg=window.Dg=function(Backbone,a,c,d){var e,f,g,h,i,j,k,l,m,n;return e={version:"0.1.0"},i={info:"datagrid.info",nodata:"datagrid.nodata",loading:"datagrid.loading",perpage:"datagrid.perpage",quicksearch:"datagrid.quicksearch"},g=function(a,b){var d,e;void 0===a&&(a={});for(d in b)e=b[d],void 0===a[d]||null===a[d]?a[d]=b[d]:c.isObject(b[d])&&c.isObject(a[d])&&(a[d]=g(a[d],b[d]));return a},m=function(a,b){var c,d,e;d={};for(c in a)e=a[c],b(a,c,e)||(d[c]=e);return d},l=function(a,b){var d,e,f;if(!a||!c.isObject(a))return!1;for(e=0,f=b.length;f>e;e++)if(d=b[e],void 0===a[d])return!1;return!0},k=function(){return!(void 0===window.I18n)},n=Function.prototype.call.bind(Array.prototype.slice),e.ItemView=a.ItemView.extend({constructor:function(){if(a.ItemView.prototype.constructor.apply(this,arguments),c.extend(this,c.pick(this.options,c.union(this.optionNames||[],["vent"]))),!this.vent)throw new Error("No event aggregator given.");return this.vent.on("view:refresh",this.refreshView,this),this},getTemplate:function(){return e.getTemplate(this.template)},onRender:function(){return this.vent.trigger("item:rendered",this)},refreshView:function(){throw new Error("The method refreshView(info) must be defined.")},update:function(a){return this.vent.trigger("update",a)},onClose:function(){return this.vent.off("view:refresh",this.refreshView,this)}}),e.DefaultItemView=e.ItemView.extend({constructor:function(){return e.ItemView.prototype.constructor.apply(this,arguments)},render:function(){var a;return this.isClosed=!1,this.beforeRender&&this.beforeRender(),this.trigger("before:render",this),this.trigger("item:before:render",this),a=this.serializeData(),a=this.mixinTemplateHelpers(a),this.setElement(d(this.renderTemplate(a)),!0),this.bindUIElements(),this.onRender(),this.trigger("render",this),this.trigger("item:rendered",this),this.vent.trigger("item:rendered",this),this},renderTemplate:function(b){return a.Renderer.render(this.getTemplate(),b)}}),e.InfoView=e.DefaultItemView.extend({template:"info",refreshView:function(a){return this.$el.text(k()?I18n.t(i.info,{from:a[j.from],to:a[j.to],total:a[j.items]}):"Showing "+a[j.from]+" to "+a[j.to]+" of "+a[j.items]+" entries")}}),e.PerPageView=e.DefaultItemView.extend({template:"perpage",events:{"change .per-page":"perPage"},ui:{perPage:".per-page"},refreshView:function(a){return this.ui.perPage.val(a[j.perPage])},perPage:function(){return this.update(c.object([j.perPage],[parseInt(this.ui.perPage.val())]))}}),e.ToolbarView=function(a){function d(){return d.__super__.constructor.apply(this,arguments)}return b(d,a),d.prototype.template="toolbar",d.prototype.ui={search:"[data-control=search]",refresh:"[data-control=refresh]",create:"[data-control=add]"},d.prototype.events={"keyup @ui.search":"search","click @ui.refresh":"refresh","click @ui.create":"create"},d.prototype._searchInternal=c.debounce(function(){return this.update(c.object([j.term],[this.ui.search.val().trim()]))},300),d.prototype.refreshView=function(a){return this.ui.search.val(a[j.term]),this.ui.refresh.removeClass("disabled"),this.ui.create.removeClass("disabled")},d.prototype.search=function(a){return this._searchInternal(a)},d.prototype.create=function(a){return a.preventDefault(),this.ui.create.hasClass("disabled")||this.ui.create.addClass("disabled"),this.vent.trigger("create:model")},d.prototype.refresh=function(a){return a.preventDefault(),this.ui.refresh.hasClass("disabled")?void 0:(this.ui.refresh.addClass("disabled"),this.update({}))},d}(e.DefaultItemView),e.PagerView=e.DefaultItemView.extend({optionNames:["deltaPage","css"],template:"pager",ui:{first:"[data-page-type=first]",prev:"[data-page-type=prev]",page:"[data-page-type=page]",next:"[data-page-type=next]",last:"[data-page-type=last]"},events:{"click @ui.first":"firstPage","click @ui.prev":"previousPage","click @ui.page":"toPage","click @ui.next":"nextPage","click @ui.last":"lastPage"},deltaPage:2,css:{active:"active",disabled:"disabled"},constructor:function(){return e.DefaultItemView.prototype.constructor.apply(this,arguments),this.info={},this.info[j.page]=0,this.info[j.pages]=0},refreshView:function(a){var b,c,d,e,f,g,h,i,k;if(this.info=a,this.$el.empty(),g=this._getPageElements(),f=this.info[j.page],h=this.info[j.pages],f>0&&h>1){if(e=f-this.deltaPage,d=f+this.deltaPage,0>=e&&(e=1),d>=h&&(d=h),i=1===f?this.css.disabled:"",void 0!==g.first&&this.$el.append(this._createLink(g.first,i)),void 0!==g.prev&&this.$el.append(this._createLink(g.prev,i)),void 0!==g.page){for(void 0!==g.before&&e>1&&this.$el.append(this._createLink(g.before,this.css.disabled)),c=k=e;d>=e?d>=k:k>=d;c=d>=e?++k:--k)b=c===f?this.css.active:"",this.$el.append(this._createPageLink(g.page,c,b));void 0!==g.after&&h>d&&this.$el.append(this._createLink(g.after,this.css.disabled))}return i=f===h?this.css.disabled:"",void 0!==g.next&&this.$el.append(this._createLink(g.next,i)),void 0!==g.last&&this.$el.append(this._createLink(g.last,i)),this.bindUIElements()}},renderTemplate:function(){return this._getPageElements().container.clone()},firstPage:function(){return this._changePage(1)},previousPage:function(){var a;return a=this.info[j.page]-1>0?this.info[j.page]-1:this.info[j.page],this._changePage(a)},toPage:function(a){return this._changePage(parseInt(d(a.target).text()))},nextPage:function(){var a;return a=this.info[j.page]+1<this.info[j.pages]?this.info[j.page]+1:this.info[j.pages],this._changePage(a)},lastPage:function(){return this._changePage(this.info[j.pages])},_changePage:function(a){return a!==this.info[j.page]?this.update(c.object([j.page],[a])):void 0},_getPageElements:function(){var a,b,c;return void 0===this.pagerTemplate&&(c=d(this.getTemplate()(null)),b=function(a){return c.filter(a).add(c.find(a))},a=c.length>1?d("<div />"):c.clone().empty(),this.pagerTemplate={first:b('[data-page-type="first"]').clone(),prev:b('[data-page-type="prev"]').clone(),before:b('[data-page-type="more-before"]').clone(),page:b('[data-page-type="page"]').clone(),after:b('[data-page-type="more-after"]').clone(),next:b('[data-page-type="next"]').clone(),last:b('[data-page-type="last"]').clone(),container:a}),this.pagerTemplate},_createLink:function(a,b){return a.clone().addClass(b)},_createPageLink:function(a,b,c){var d,e,f;return d=a.clone(),e=void 0===d.attr("data-page-content")?d.find("*[data-page-content]"):d,f=e.attr("data-page-content"),"arabic"===f&&e.text(""+b),d.addClass(c).attr("data-page",""+b)}}),e.RowView=e.ItemView.extend({optionNames:["css","cellTagName"],tagName:"tr",events:{"click .edit":"edit","click .delete":"delete"},css:{asc:"sorting-asc",desc:"sorting-desc",none:null},cellTagName:"td",refreshView:function(a){var b,c,e,f,g;if(a[j.sort]){for(f=this.$el.find(this.cellTagName),g=[],c=0,e=f.length;e>c;c++)b=f[c],b=d(b),b.removeClass(""+this.css.asc+" "+this.css.desc),this.css.none&&b.removeClass(this.css.none),g.push(a[j.sort][b.index()]?a[j.sort][b.index()]===j.asc?b.addClass(this.css.asc):b.addClass(this.css.desc):this.css.none?b.addClass(this.css.none):void 0);return g}},edit:function(a){return a.preventDefault(),this.vent.trigger("row:edit",this.model)},"delete":function(a){return a.preventDefault(),this.vent.trigger("row:delete",this.model)}}),e.EmptyView=e.DefaultItemView.extend({optionNames:["columns"],template:"empty",ui:{empty:".empty"},onRender:function(){return this.$el.attr("colspan",this.columns)},refreshView:function(){}}),f=Backbone.Marionette.ItemView.extend({template:"gridempty",getTemplate:function(){return e.getTemplate(this.template)}}),e.HeaderView=e.ItemView.extend({optionNames:["parentSelector","appendMode","columnTag","sortTag","css"],tagName:"thead",parentSelector:"table",appendMode:"prepend",columnTag:"th",sortTag:"th",css:{sortable:"sorting",asc:"sorting-asc",desc:"sorting-desc",none:"sorting-none"},events:{"click .sorting":"sort"},refreshView:function(a){var b,c,e,f,g,h,i;for(b=0,h=this.$el.find(""+this.sortTag+"."+this.css.sortable),i=[],f=0,g=h.length;g>f;f++)e=h[f],c=d(e),c.removeClass(""+this.css.asc+" "+this.css.desc+" "+this.css.none),a[j.sort]&&(this.sortConfiguration=a[j.sort],c.addClass(this.sortConfiguration[b]?this.sortConfiguration[b]===j.asc?this.css.asc:this.css.desc:this.css.none)),i.push(b++);return i},sort:function(a){var b;return b=d("."+this.css.sortable,this.$el).index(d(a.target)),this.sortConfiguration||(this.sortConfiguration={}),a.altKey||(this.sortConfiguration=this.sortConfiguration[b]?c.pick(this.sortConfiguration,b):{}),this.sortConfiguration[b]=void 0===this.sortConfiguration[b]?j.asc:this.sortConfiguration[b]===j.asc?j.desc:void 0,this.update(c.object([j.sort],[this.sortConfiguration]))},columns:function(){return this.$el.find(this.columnTag).length}}),e.TableView=a.CompositeView.extend({template:"table",itemViewContainer:"tbody",emptyView:e.EmptyView,itemViewOptions:function(){return{vent:this.vent,columns:this.columns()}},constructor:function(){return a.CompositeView.prototype.constructor.apply(this,n(arguments)),c.extend(this,c.pick(this.options,"vent"))},getTemplate:function(){return e.getTemplate(this.template)},onCompositeModelRendered:function(){var a;return this.headerView&&(this.header=new this.headerView(this.options),a=void 0===this.header.parentSelector||""===this.header.parentSelector?"table":this.header.parentSelector,void 0===this.header.appendMode||"prepend"!==this.header.appendMode?this.$el.find(a).append(this.header.render().el):this.$el.find(a).prepend(this.header.render().el)),this.trigger("render")},beforeClose:function(){return this.header?this.header.close():void 0},columns:function(){return this.header?this.header.columns():0}}),e.TableRegion=a.Region.extend,e.GridLayout=a.Layout.extend({template:"grid",constructor:function(){return this.vent=new Backbone.Wreqr.EventAggregator,a.Layout.prototype.constructor.apply(this,n(arguments)),this.on("render",this.renderRegions),this.listenTo(this.vent,"update",this.handleUpdate),this.listenTo(this.vent,"refresh",this.handleRefresh),this.listenTo(this.vent,"row:edit",this.handleEdit),this.listenTo(this.vent,"row:delete",this.handleDelete),this.listenTo(this.vent,"create:model",this.handleCreate),this.listenTo(this.collection,"fetched",this.refreshGrid),this.listenTo(this.collection,"info:updated",this.refreshGrid)},getTemplate:function(){return e.getTemplate(this.template)},renderRegions:function(){var a,b,d,e;e=this.regions;for(d in e)b=e[d],"table"!==d&&(a=c.extend({vent:this.vent},b.options||{}),this[d].show(new b.view(c.extend(a,this.options))));return this.table.show(new f),this.collection.fetch()},refreshGrid:function(){return this.table.show(new this.regions.table.view(c.extend({vent:this.vent,collection:this.collection},this.options))),this.refreshInfo()},refreshInfo:function(){return this.vent.trigger("view:refresh",this.collection.getInfo())},handleUpdate:function(a){return this.table.show(new f),this.collection.updateInfo(a)},handleRefresh:function(){return this.collection.refresh()},handleEdit:function(a){return this.trigger("edit",a)},handleDelete:function(a){return this.trigger("delete",a)},handleCreate:function(){return this.trigger("new")},onClose:function(){return this.collection.off("fetched",this.refreshGrid)}}),e.createRowView=function(a){if(!l(a,["template","model"]))throw new Error("template or model is missing in the options");return e.RowView.extend(a)},e.createHeaderView=function(a){if(!l(a,["template"]))throw new Error("template is missing in the options");return e.HeaderView.extend(a)},e.createTableView=function(a){if(!l(a,["template","itemViewContainer","itemView"]))throw new Error("template, itemViewContainer or itemView is missing in the options");return e.TableView.extend(a)},e.createGridLayout=function(a){var b,d;return a=a||{},d=a.gridRegions||{},d=m(g(d,h),function(a,b,d){return!c.isObject(d)}),b=e.GridLayout.extend(void 0===a.collection?{regions:d}:{collection:a.collection,regions:d}),void 0!==a.template&&(b.prototype.template=a.template),b},j={from:"from",to:"to",items:"items",totalItems:"totalItems",perPage:"perPage",pages:"pages",page:"page",term:"term",sort:"sort",asc:"A",desc:"D"},h={table:{selector:".dgTable",view:e.TableView},toolbar:{selector:".dgToolbar",view:e.ToolbarView},perPage:{selector:".dgPerPage",view:e.PerPageView},info:{selector:".dgInfo",view:e.InfoView},pager:{selector:".dgPager",view:e.PagerView}},e.setupDefaultI18nBindings=function(a){return e.i18nKeys=c.defaults(a.i18n||{},e.i18nKeys)},e.setupDefaultInfoBindings=function(a){return j=c.defaults(a.bindings||{},j)},e.setupDefaultGridLayout=function(a){return h=g(a.gridRegions||{},h)},e.getTemplate=function(a){throw console.log("Get template root "+a),new Error("There is no template engine available")},e}(Backbone,Backbone.Marionette,_,$||window.jQuery||window.Zepto||window.ender)}).call(this);