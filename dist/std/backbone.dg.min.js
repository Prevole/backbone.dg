/*
 * backbone.dg - v0.0.1
 * Copyright (c) 2013-03-28 Laurent Pr√©vost (prevole) <prevole@prevole.ch>
 * Distributed under MIT license
 * https://github.com/prevole/backbone.dg
 */
(function(){var e={}.hasOwnProperty,t=function(t,i){function r(){this.constructor=t}for(var n in i)e.call(i,n)&&(t[n]=i[n]);return r.prototype=i.prototype,t.prototype=new r,t.__super__=i.prototype,t};window.Backbone.Dg=window.Dg=function(Backbone,e,i,r){var n,s,o,a,p,u,l,h,c,d;return n={version:"0.0.1"},o=function(e,t){var r,n;void 0===e&&(e={});for(r in t)n=t[r],void 0===e[r]||null===e[r]?e[r]=t[r]:i.isObject(t[r])&&i.isObject(e[r])&&(e[r]=o(e[r],t[r]));return e},c=function(e,t){var i,r,n;r={};for(i in e)n=e[i],t(e,i,n)||(r[i]=n);return r},h=function(e,t){var r,n,s;if(!e||!i.isObject(e))return!1;for(n=0,s=t.length;s>n;n++)if(r=t[n],void 0===e[r])return!1;return!0},l=function(){return!(void 0===window.I18n)},d={empty:function(){return"<td class='empty'>No Data</td>"},grid:function(){return"<div class='dgGrid'><div class='clearfix'><div class='dgPerPage' /><div class='dgToolbar' /><div class='dgQuickSearch' /></div><div class='dgTable' /><div class='clearfix'><div class='dgInfo pull-left' /><div class='dgPager pull-right' /></div></div>"},gridempty:function(){return"<div class='dgLoading'><div class='progress progress-striped active'><div class='bar' style='width:100%'>Loading data</div></div></div>"},info:function(){return"<span class='info' />"},pager:function(){return"<div class='pagination pagination-right' />"},perpage:function(){return"<div class='form-inline pull-left'><label class='checkbox'>Item per page:&nbsp;</label><select class='per-page input-mini'><option>2</option><option>5</option><option>10</option><option>25</option><option>50</option><option>100</option></select></div>"},quicksearch:function(){return"<div class='form-inline pull-right qs'><label class='checkbox'>Quick search:&nbsp;</label><input type='text' /></div>"},table:function(){return"<table class='table table-striped table-hover table-condensed'><tbody/></table>"},toolbar:function(){return"<div class='form-inline pull-right buttons btn-group'><button class='btn refresh'><i class='icon-refresh'/></button><button class='btn create'><i class='icon-plus'/></button></div>"}},n.registerTemplate=function(e,t){return d[e]=t},n.ItemView=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return t(i,e),i.prototype.initialize=function(e){if(!e.vent)throw Error("No event aggregator given.");return this.vent=e.vent,this.vent.on("view:refresh",this.refreshView,this)},i.prototype.render=function(){return i.__super__.render.apply(this,arguments),this.vent.trigger("item:rendered",this),this},i.prototype.refreshView=function(){throw Error("The method refreshView(info) must be defined.")},i.prototype.update=function(e){return this.vent.trigger("update",e)},i.prototype.close=function(){return this.vent.off("view:refresh",this.refreshView),i.__super__.close.apply(this,arguments)},i}(e.ItemView),n.DefaultItemView=function(i){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,i),n.prototype.render=function(){return this.beforeRender&&this.beforeRender(),this.trigger("before:render",this),this.trigger("item:before:render",this),this.setElement(r(e.Renderer.render(this.getTemplate(),this.serializeData())),!0),this.bindUIElements(),this.onRender&&this.onRender(),this.trigger("render",this),this.trigger("item:rendered",this),this.vent.trigger("item:rendered",this),this},n}(n.ItemView),n.InfoView=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return t(i,e),i.prototype.template=d.info,i.prototype.refreshView=function(e){return l()?this.$el.text(I18n.t(p.info,{from:e[u.from],to:e[u.to],total:e[u.items]})):this.$el.text("Showing "+e[u.from]+" to "+e[u.to]+" of "+e[u.items]+" entries")},i}(n.DefaultItemView),n.QuickSearchView=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return t(r,e),r.prototype.template=d.quicksearch,r.prototype.events={"keyup input":"search"},r.prototype.ui={term:"input"},r.prototype.initialize=function(e){var t=this;return r.__super__.initialize.call(this,e),this.searchInternal=i.debounce(function(){return t.update(i.object([u.term],[t.ui.term.val().trim()]))},300)},r.prototype.refreshView=function(e){return this.ui.term.val(e[u.term])},r.prototype.search=function(e){return this.searchInternal(e)},r}(n.DefaultItemView),n.PerPageView=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return t(r,e),r.prototype.template=d.perpage,r.prototype.events={"change .per-page":"perPage"},r.prototype.ui={perPage:".per-page"},r.prototype.refreshView=function(e){return this.ui.perPage.val(e[u.perPage])},r.prototype.perPage=function(){return this.update(i.object([u.perPage],[parseInt(this.ui.perPage.val())]))},r}(n.DefaultItemView),n.ToolbarView=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return t(i,e),i.prototype.template=d.toolbar,i.prototype.events={"click .refresh":"refresh","click .create":"create"},i.prototype.ui={create:".create",refresh:".refresh"},i.prototype.refreshView=function(){return this.ui.refresh.removeClass("disabled"),this.ui.create.removeClass("disabled")},i.prototype.create=function(e){return e.preventDefault(),this.ui.create.hasClass("disabled")||this.ui.create.addClass("disabled"),this.vent.trigger("create:model")},i.prototype.refresh=function(e){return e.preventDefault(),this.ui.refresh.hasClass("disabled")?void 0:(this.ui.refresh.addClass("disabled"),this.update({}))},i}(n.DefaultItemView),n.PagerView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}var s;return t(n,e),n.prototype.template=d.pager,n.prototype.events={"click a":"pagging"},n.prototype.initialize=function(e){return n.__super__.initialize.call(this,e),this.deltaPage=e.deltaPage||2,this.css=i.defaults(e.css||{},{active:"active",disabled:"disabled",page:"page"}),this.texts=l()?i.defaults(e.texts||{},{first:I18n.t(p.pager.first),previous:I18n.t(p.pager.previous),next:I18n.t(p.pager.next),last:I18n.t(p.pager.last),filler:I18n.t(p.pager.filler)}):i.defaults(e.texts||{},{first:"<<",previous:"<",next:">",last:">>",filler:"..."}),this.numbers=!0,void 0!==e.numbers&&(this.numbers=e.numbers),this.firstAndLast=!0,void 0!==e.firstAndLast&&(this.firstAndLast=e.firstAndLast),this.previousAndNext=!0,void 0!==e.previousAndNext&&(this.previousAndNext=e.previousAndNext),this.info={},this.info[u.page]=0,this.info[u.pages]=0},n.prototype.refreshView=function(e){var t,i,n,o,a,p,l,h,c;if(this.info=e,this.$el.empty().hide(),h=r("<ul />"),a=this.info[u.page],p=this.info[u.pages],a>0&&p>1){if(o=a-this.deltaPage,n=a+this.deltaPage,0>=o&&(o=1),n>=p&&(n=p),l=1===a?this.css.disabled:"",this.firstAndLast&&h.append(s.call(this,this.texts.first,"f",l)),this.previousAndNext&&h.append(s.call(this,this.texts.previous,"p",l)),this.numbers){for(o>1&&h.append(s.call(this,this.texts.filler,"",this.css.disabled)),i=c=o;n>=o?n>=c:c>=n;i=n>=o?++c:--c)t=i===a?this.css.active:"",h.append(s.call(this,""+i,"page",t));p>n&&h.append(s.call(this,this.texts.filler,"",this.css.disabled))}return l=a===p?this.css.disabled:"",this.previousAndNext&&h.append(s.call(this,this.texts.next,"n",l)),this.firstAndLast&&h.append(s.call(this,this.texts.last,"l",l)),this.$el.append(h).show()}},n.prototype.pagging=function(e){var t,n,s;if(e.preventDefault(),n=r(e.target),!n.parent().hasClass(this.css.disabled)&&!n.parent().hasClass(this.css.active)){switch(s=n.data("type")){case"f":t=1;break;case"p":t=this.info[u.page]-1>0?this.info[u.page]-1:this.info[u.page];break;case"n":t=this.info[u.page]+1<this.info[u.pages]?this.info[u.page]+1:this.info[u.pages];break;case"l":t=this.info[u.pages];break;default:t=parseInt(r(e.target).text())}if(t!==this.info[u.page])return this.update(i.object([u.page],[t]))}},s=function(e,t,i){var n,s;return n=r("<a/>").attr("href","#").data("type",t).addClass(this.css.page).html(""+e),s=r("<li />").html(n),i&&s.addClass(i),s},n}(n.DefaultItemView),n.RowView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.tagName="tr",n.prototype.events={"click .edit":"edit","click .delete":"delete"},n.prototype.initialize=function(e){return n.__super__.initialize.call(this,e),this.css=i.defaults(e.css||{},{asc:"sorting-asc",desc:"sorting-desc"}),this.cellTagName=e.cellTagName||"td"},n.prototype.refreshView=function(e){var t,i,n,s,o;if(e[u.sort]){for(s=this.$el.find(this.cellTagName),o=[],i=0,n=s.length;n>i;i++)t=s[i],t=r(t),t.removeClass(""+this.css.asc+" "+this.css.desc),this.css.none&&t.removeClass(this.css.none),e[u.sort][t.index()]?e[u.sort][t.index()]===u.asc?o.push(t.addClass(this.css.asc)):o.push(t.addClass(this.css.desc)):this.css.none?o.push(t.addClass(this.css.none)):o.push(void 0);return o}},n.prototype.edit=function(e){return e.preventDefault(),this.vent.trigger("row:edit",this.model)},n.prototype["delete"]=function(e){return e.preventDefault(),this.vent.trigger("row:delete",this.model)},n}(n.ItemView),n.EmptyView=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return t(i,e),i.prototype.template=d.empty,i.prototype.ui={empty:".empty"},i.prototype.initialize=function(e){return this.columns=e.columns,i.__super__.initialize.call(this,e)},i.prototype.onRender=function(){return this.$el.attr("colspan",this.columns)},i.prototype.refreshView=function(){},i}(n.DefaultItemView),s=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return t(i,e),i.prototype.template=d.gridempty,i}(Backbone.Marionette.ItemView),n.HeaderView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.tagName="thead",n.prototype.parentTagName="table",n.prototype.events={"click .sorting":"sort"},n.prototype.refreshView=function(e){var t,i,n,s,o;for(s=this.$el.find("th"),o=[],i=0,n=s.length;n>i;i++)t=s[i],t=r(t),t.hasClass("sorting")?(t.removeClass("sorting-asc sorting-desc"),e[u.sort]?(this.sortConfiguration=e[u.sort],this.sortConfiguration[t.index()]?this.sortConfiguration[t.index()]===u.asc?o.push(t.addClass("sorting-asc")):o.push(t.addClass("sorting-desc")):o.push(void 0)):o.push(void 0)):o.push(void 0);return o},n.prototype.sort=function(e){var t;return t=r(e.target).index(),this.sortConfiguration||(this.sortConfiguration={}),e.shiftKey||(this.sortConfiguration=this.sortConfiguration[t]?i.pick(this.sortConfiguration,t):{}),this.sortConfiguration[t]=void 0===this.sortConfiguration[t]?u.asc:this.sortConfiguration[t]===u.asc?u.desc:void 0,this.update(i.object([u.sort],[this.sortConfiguration]))},n.prototype.columns=function(){return this.$el.find("th").length},n}(n.ItemView),n.TableView=e.CompositeView.extend({template:d.table,itemViewContainer:"tbody",emptyView:n.EmptyView,itemViewOptions:function(){return{vent:this.vent,columns:this.columns()}},initialize:function(e){return this.vent=e.vent,this.collection=e.collection},onCompositeModelRendered:function(){return this.headerView&&(this.header=new this.headerView(this.options),this.$el.find(this.header.parentTagName||"table").prepend(this.header.render().el)),this.trigger("render")},beforeClose:function(){return this.header?this.header.close():void 0},columns:function(){return this.header?this.header.columns():0}}),n.TableRegion=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return t(i,e),i}(e.Region),n.GridLayout=function(e){function r(){var e=this;return this.handleCreate=function(){return r.prototype.handleCreate.apply(e,arguments)},this.handleDelete=function(){return r.prototype.handleDelete.apply(e,arguments)},this.handleEdit=function(){return r.prototype.handleEdit.apply(e,arguments)},this.handleRefresh=function(){return r.prototype.handleRefresh.apply(e,arguments)},this.handleUpdate=function(){return r.prototype.handleUpdate.apply(e,arguments)},this.refreshGrid=function(){return r.prototype.refreshGrid.apply(e,arguments)},this.renderRegions=function(){return r.prototype.renderRegions.apply(e,arguments)},r.__super__.constructor.apply(this,arguments)}return t(r,e),r.prototype.template=d.grid,r.prototype.initialize=function(){return this.vent=new Backbone.Wreqr.EventAggregator,this.on("render",this.renderRegions),this.vent.on("update",this.handleUpdate),this.vent.on("refresh",this.handleRefresh),this.vent.on("row:edit",this.handleEdit),this.vent.on("row:delete",this.handleDelete),this.vent.on("create:model",this.handleCreate),this.collection.on("fetched",this.refreshGrid)},r.prototype.renderRegions=function(){var e,t,r,n;n=this.regions;for(r in n)t=n[r],"table"!==r&&(e=i.extend({vent:this.vent},t.options||{}),this[r].show(new t.view(i.extend(e,this.options))));return this.table.show(new s),this.collection.fetch()},r.prototype.refreshGrid=function(){return this.table.show(new this.regions.table.view(i.extend({vent:this.vent,collection:this.collection},this.options))),this.vent.trigger("view:refresh",this.collection.getInfo())},r.prototype.handleUpdate=function(e){return this.table.show(new s),this.collection.updateInfo(e)},r.prototype.handleRefresh=function(){return this.collection.refresh()},r.prototype.handleEdit=function(e){return this.trigger("edit",e)},r.prototype.handleDelete=function(e){return this.trigger("delete",e)},r.prototype.handleCreate=function(){return this.trigger("new")},r.prototype.close=function(){return this.collection.off("fetched",this.refreshGrid),r.__super__.close.apply(this,arguments)},r}(e.Layout),n.createRowView=function(e){if(!h(e,["template","model"]))throw Error("template or model is missing in the options");return n.RowView.extend(e)},n.createHeaderView=function(e){if(!h(e,["template"]))throw Error("template is missing in the options");return n.HeaderView.extend(e)},n.createTableView=function(e){if(!h(e,["template","itemViewContainer","itemView"]))throw Error("template, itemViewContainer or itemView is missing in the options");return n.TableView.extend(e)},n.createGridLayout=function(e){var t,r;return e=e||{},r=e.gridRegions||{},r=c(o(r,a),function(e,t,r){return!i.isObject(r)}),t=void 0===e.collection?n.GridLayout.extend({regions:r}):n.GridLayout.extend({collection:e.collection,regions:r}),void 0!==e.template&&(t.prototype.template=d[e.template]),t},p={info:"datagrid.info",pager:{first:"datagrid.pager.first",last:"datagrid.pager.last",next:"datagrid.pager.next",previous:"datagrid.pager.previous",filler:"datagrid.pager.filler"}},u={from:"from",to:"to",items:"items",totalItems:"totalItems",perPage:"perPage",pages:"pages",page:"page",term:"term",sort:"sort",asc:"A",desc:"D"},a={table:{selector:".dgTable",regionType:n.TableRegion,view:n.TableView},toolbar:{selector:".dgToolbar",view:n.ToolbarView},quickSearch:{selector:".dgQuickSearch",view:n.QuickSearchView},perPage:{selector:".dgPerPage",view:n.PerPageView},info:{selector:".dgInfo",view:n.InfoView},pager:{selector:".dgPager",view:n.PagerView}},n.setupDefaultI18nBindings=function(e){return p=i.defaults(e.i18n||{},p)},n.setupDefaultInfoBindings=function(e){return u=i.defaults(e.bindings||{},u)},n.setupDefaultGridLayout=function(e){return a=o(e.gridRegions||{},a)},n}(Backbone,Backbone.Marionette,_,$||window.jQuery||window.Zepto||window.ender)}).call(this);