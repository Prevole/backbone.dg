/*
 * backbone.dg - v0.0.1
 * Copyright (c) 2013-03-25 Laurent Pr√©vost (prevole) <prevole@prevole.ch>
 * Distributed under MIT license
 * https://github.com/prevole/backbone.dg
 */
(function(){var e={}.hasOwnProperty,t=function(t,r){function i(){this.constructor=t}for(var n in r)e.call(r,n)&&(t[n]=r[n]);return i.prototype=r.prototype,t.prototype=new i,t.__super__=r.prototype,t};window.Backbone.Dg=window.Dg=function(Backbone,e,r,i){var n,s,o,a,p,u,l,h,c,d,f;return n={version:"0.0.1"},a=function(e,t){var i,n;void 0===e&&(e={});for(i in t)n=t[i],void 0===e[i]||null===e[i]?e[i]=t[i]:r.isObject(t[i])&&r.isObject(e[i])&&(e[i]=a(e[i],t[i]));return e},d=function(e,t){var r,i,n;i={};for(r in e)n=e[r],t(e,r,n)||(i[r]=n);return i},c=function(e,t){var i,n,s;if(!e||!r.isObject(e))return!1;for(n=0,s=t.length;s>n;n++)if(i=t[n],void 0===e[i])return!1;return!0},h=function(){return!(void 0===window.I18n)},f={empty:function(){return"<td class='empty'>No Data</td>"},grid:function(){return"<div class='dgGrid'><div class='clearfix'><div class='dgPerPage' /><div class='dgToolbar' /><div class='dgQuickSearch' /></div><div class='dgTable' /><div class='clearfix'><div class='dgInfo pull-left' /><div class='dgPager pull-right' /></div></div>"},gridempty:function(){return"<div class='dgLoading'><div class='progress progress-striped active'><div class='bar' style='width:100%'>Loading data</div></div></div>"},info:function(){return"<span class='info' />"},pager:function(){return"<div class='pagination pagination-right' />"},perpage:function(){return"<div class='form-inline pull-left'><label class='checkbox'>Item per page:&nbsp;</label><select class='per-page input-mini'><option>2</option><option>5</option><option>10</option><option>25</option><option>50</option><option>100</option></select></div>"},quicksearch:function(){return"<div class='form-inline pull-right qs'><label class='checkbox'>Quick search:&nbsp;</label><input type='text' /></div>"},table:function(){return"<table class='table table-striped table-hover table-condensed'><tbody/></table>"},toolbar:function(){return"<div class='form-inline pull-right buttons btn-group'><button class='btn refresh'><i class='icon-refresh'/></button><button class='btn create'><i class='icon-plus'/></button></div>"}},n.registerTemplate=function(e,t){return f[e]=t},n.ItemView=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return t(r,e),r.prototype.initialize=function(e){if(!e.vent)throw Error("No event aggregator given.");return this.vent=e.vent,this.vent.on("view:refresh",this.refreshView,this)},r.prototype.render=function(){return r.__super__.render.apply(this,arguments),this.vent.trigger("item:rendered",this),this},r.prototype.refreshView=function(){throw Error("The method refreshView(info) must be defined.")},r.prototype.update=function(e){return this.vent.trigger("update",e)},r.prototype.close=function(){return this.vent.off("view:refresh",this.refreshView),r.__super__.close.apply(this,arguments)},r}(e.ItemView),n.DefaultItemView=function(r){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,r),n.prototype.render=function(){return this.beforeRender&&this.beforeRender(),this.trigger("before:render",this),this.trigger("item:before:render",this),this.setElement(i(e.Renderer.render(this.getTemplate(),this.serializeData())),!0),this.bindUIElements(),this.onRender&&this.onRender(),this.trigger("render",this),this.trigger("item:rendered",this),this.vent.trigger("item:rendered",this),this},n}(n.ItemView),n.InfoView=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return t(r,e),r.prototype.template=f.info,r.prototype.refreshView=function(e){return h()?this.$el.text(I18n.t(u.info,{from:e[l.from],to:e[l.to],total:e[l.items]})):this.$el.text("Showing "+e[l.from]+" to "+e[l.to]+" of "+e[l.items]+" entries")},r}(n.DefaultItemView),n.QuickSearchView=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return t(i,e),i.prototype.template=f.quicksearch,i.prototype.events={"keyup input":"search"},i.prototype.ui={term:"input"},i.prototype.initialize=function(e){var t=this;return i.__super__.initialize.call(this,e),this.searchInternal=r.debounce(function(){return t.update(r.object([l.term],[t.ui.term.val().trim()]))},300)},i.prototype.refreshView=function(e){return this.ui.term.val(e[l.term])},i.prototype.search=function(e){return this.searchInternal(e)},i}(n.DefaultItemView),n.PerPageView=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return t(i,e),i.prototype.template=f.perpage,i.prototype.events={"change .per-page":"perPage"},i.prototype.ui={perPage:".per-page"},i.prototype.refreshView=function(e){return this.ui.perPage.val(e[l.perPage])},i.prototype.perPage=function(){return this.update(r.object([l.perPage],[parseInt(this.ui.perPage.val())]))},i}(n.DefaultItemView),n.ToolbarView=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return t(r,e),r.prototype.template=f.toolbar,r.prototype.events={"click .refresh":"refresh","click .create":"create"},r.prototype.ui={create:".create",refresh:".refresh"},r.prototype.refreshView=function(){return this.ui.refresh.removeClass("disabled"),this.ui.create.removeClass("disabled")},r.prototype.create=function(e){return e.preventDefault(),this.ui.create.hasClass("disabled")||this.ui.create.addClass("disabled"),this.vent.trigger("create:model")},r.prototype.refresh=function(e){return e.preventDefault(),this.ui.refresh.hasClass("disabled")?void 0:(this.ui.refresh.addClass("disabled"),this.update({}))},r}(n.DefaultItemView),n.PagerView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}var s;return t(n,e),n.prototype.template=f.pager,n.prototype.events={"click a":"pagging"},n.prototype.initialize=function(e){return n.__super__.initialize.call(this,e),this.deltaPage=e.deltaPage||2,this.css=r.defaults(e.css||{},{active:"active",disabled:"disabled",page:"page"}),this.texts=h()?r.defaults(e.texts||{},{first:I18n.t(u.pager.first),previous:I18n.t(u.pager.previous),next:I18n.t(u.pager.next),last:I18n.t(u.pager.last),filler:I18n.t(u.pager.filler)}):r.defaults(e.texts||{},{first:"<<",previous:"<",next:">",last:">>",filler:"..."}),this.numbers=!0,void 0!==e.numbers&&(this.numbers=e.numbers),this.firstAndLast=!0,void 0!==e.firstAndLast&&(this.firstAndLast=e.firstAndLast),this.previousAndNext=!0,void 0!==e.previousAndNext&&(this.previousAndNext=e.previousAndNext),this.info={},this.info[l.page]=0,this.info[l.pages]=0},n.prototype.refreshView=function(e){var t,r,n,o,a,p,u,h,c;if(this.info=e,this.$el.empty().hide(),h=i("<ul />"),a=this.info[l.page],p=this.info[l.pages],a>0&&p>1){if(o=a-this.deltaPage,n=a+this.deltaPage,0>=o&&(o=1),n>=p&&(n=p),u=1===a?this.css.disabled:"",this.firstAndLast&&h.append(s.call(this,this.texts.first,"f",u)),this.previousAndNext&&h.append(s.call(this,this.texts.previous,"p",u)),this.numbers){for(o>1&&h.append(s.call(this,this.texts.filler,"",this.css.disabled)),r=c=o;n>=o?n>=c:c>=n;r=n>=o?++c:--c)t=r===a?this.css.active:"",h.append(s.call(this,""+r,"page",t));p>n&&h.append(s.call(this,this.texts.filler,"",this.css.disabled))}return u=a===p?this.css.disabled:"",this.previousAndNext&&h.append(s.call(this,this.texts.next,"n",u)),this.firstAndLast&&h.append(s.call(this,this.texts.last,"l",u)),this.$el.append(h).show()}},n.prototype.pagging=function(e){var t,n,s;if(e.preventDefault(),n=i(e.target),!n.parent().hasClass(this.css.disabled)&&!n.parent().hasClass(this.css.active)){switch(s=n.data("type")){case"f":t=1;break;case"p":t=this.info[l.page]-1>0?this.info[l.page]-1:this.info[l.page];break;case"n":t=this.info[l.page]+1<this.info[l.pages]?this.info[l.page]+1:this.info[l.pages];break;case"l":t=this.info[l.pages];break;default:t=parseInt(i(e.target).text())}if(t!==this.info[l.page])return this.update(r.object([l.page],[t]))}},s=function(e,t,r){var n,s;return n=i("<a/>").attr("href","#").data("type",t).addClass(this.css.page).html(""+e),s=i("<li />").html(n),r&&s.addClass(r),s},n}(n.DefaultItemView),n.RowView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.tagName="tr",n.prototype.events={"click .edit":"edit","click .delete":"delete"},n.prototype.initialize=function(e){return n.__super__.initialize.call(this,e),this.css=r.defaults(e.css||{},{asc:"sorting-asc",desc:"sorting-desc"}),this.cellTagName=e.cellTagName||"td"},n.prototype.refreshView=function(e){var t,r,n,s,o;if(e[l.sort]){for(s=this.$el.find(this.cellTagName),o=[],r=0,n=s.length;n>r;r++)t=s[r],t=i(t),t.removeClass(""+this.css.asc+" "+this.css.desc),this.css.none&&t.removeClass(this.css.none),e[l.sort][t.index()]?e[l.sort][t.index()]===l.asc?o.push(t.addClass(this.css.asc)):o.push(t.addClass(this.css.desc)):this.css.none?o.push(t.addClass(this.css.none)):o.push(void 0);return o}},n.prototype.edit=function(e){return e.preventDefault(),this.vent.trigger("row:edit",this.model)},n.prototype["delete"]=function(e){return e.preventDefault(),this.vent.trigger("row:delete",this.model)},n}(n.ItemView),s=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return t(r,e),r.prototype.template=f.empty,r.prototype.ui={empty:".empty"},r.prototype.initialize=function(e){return this.columns=e.columns,r.__super__.initialize.call(this,e)},r.prototype.onRender=function(){return this.$el.attr("colspan",this.columns)},r.prototype.refreshView=function(){},r}(n.DefaultItemView),o=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return t(r,e),r.prototype.template=f.gridempty,r}(Backbone.Marionette.ItemView),n.HeaderView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.tagName="thead",n.prototype.parentTagName="table",n.prototype.events={"click .sorting":"sort"},n.prototype.refreshView=function(e){var t,r,n,s,o;for(s=this.$el.find("th"),o=[],r=0,n=s.length;n>r;r++)t=s[r],t=i(t),t.hasClass("sorting")?(t.removeClass("sorting-asc sorting-desc"),e[l.sort]?(this.sortConfiguration=e[l.sort],this.sortConfiguration[t.index()]?this.sortConfiguration[t.index()]===l.asc?o.push(t.addClass("sorting-asc")):o.push(t.addClass("sorting-desc")):o.push(void 0)):o.push(void 0)):o.push(void 0);return o},n.prototype.sort=function(e){var t;return t=i(e.target).index(),this.sortConfiguration||(this.sortConfiguration={}),e.shiftKey||(this.sortConfiguration=this.sortConfiguration[t]?r.pick(this.sortConfiguration,t):{}),this.sortConfiguration[t]=void 0===this.sortConfiguration[t]?l.asc:this.sortConfiguration[t]===l.asc?l.desc:void 0,this.update(r.object([l.sort],[this.sortConfiguration]))},n.prototype.columns=function(){return this.$el.find("th").length},n}(n.ItemView),n.TableView=e.CompositeView.extend({template:f.table,itemViewContainer:"tbody",emptyView:n.EmptyView,itemViewOptions:function(){return{vent:this.vent,columns:this.columns()}},initialize:function(e){return this.vent=e.vent,this.collection=e.collection},onCompositeModelRendered:function(){return this.headerView&&(this.header=new this.headerView({vent:this.vent}),this.$el.find(this.header.parentTagName||"table").prepend(this.header.render().el)),this.trigger("render")},beforeClose:function(){return this.header?this.header.close():void 0},columns:function(){return this.header?this.header.columns():0}}),n.TableRegion=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return t(r,e),r}(e.Region),n.GridLayout=function(e){function i(){var e=this;return this.handleCreate=function(){return i.prototype.handleCreate.apply(e,arguments)},this.handleDelete=function(){return i.prototype.handleDelete.apply(e,arguments)},this.handleEdit=function(){return i.prototype.handleEdit.apply(e,arguments)},this.handleRefresh=function(){return i.prototype.handleRefresh.apply(e,arguments)},this.handleUpdate=function(){return i.prototype.handleUpdate.apply(e,arguments)},this.refreshGrid=function(){return i.prototype.refreshGrid.apply(e,arguments)},this.renderRegions=function(){return i.prototype.renderRegions.apply(e,arguments)},i.__super__.constructor.apply(this,arguments)}return t(i,e),i.prototype.template=f.grid,i.prototype.initialize=function(){return this.vent=new Backbone.Wreqr.EventAggregator,this.on("render",this.renderRegions),this.vent.on("update",this.handleUpdate),this.vent.on("refresh",this.handleRefresh),this.vent.on("row:edit",this.handleEdit),this.vent.on("row:delete",this.handleDelete),this.vent.on("create:model",this.handleCreate),this.collection.on("fetched",this.refreshGrid)},i.prototype.renderRegions=function(){var e,t,i,n;n=this.regions;for(i in n)t=n[i],"table"!==i&&(e=r.extend({vent:this.vent},t.options||{}),this[i].show(new t.view(e)));return this.table.show(new o),this.collection.fetch()},i.prototype.refreshGrid=function(){return this.table.show(new this.regions.table.view({vent:this.vent,collection:this.collection})),this.vent.trigger("view:refresh",this.collection.getInfo())},i.prototype.handleUpdate=function(e){return this.table.show(new o),this.collection.updateInfo(e)},i.prototype.handleRefresh=function(){return this.collection.refresh()},i.prototype.handleEdit=function(e){return this.trigger("edit",e)},i.prototype.handleDelete=function(e){return this.trigger("delete",e)},i.prototype.handleCreate=function(){return this.trigger("new")},i.prototype.close=function(){return this.collection.off("fetched",this.refreshGrid),i.__super__.close.apply(this,arguments)},i}(e.Layout),n.createRowView=function(e){if(!c(e,["template","model"]))throw Error("template or model is missing in the options");return n.RowView.extend(e)},n.createHeaderView=function(e){if(!c(e,["template"]))throw Error("template is missing in the options");return n.HeaderView.extend(e)},n.createTableView=function(e){if(!c(e,["template","itemViewContainer","itemView"]))throw Error("template, itemViewContainer or itemView is missing in the options");return n.TableView.extend(e)},n.createGridLayout=function(e){var t,i;return e=e||{},i=e.gridRegions||{},i=d(a(i,p),function(e,t,i){return!r.isObject(i)}),t=void 0===e.collection?n.GridLayout.extend({regions:i}):n.GridLayout.extend({collection:e.collection,regions:i}),void 0!==e.template&&(t.prototype.template=f[e.template]),t},u={info:"datagrid.info",pager:{first:"datagrid.pager.first",last:"datagrid.pager.last",next:"datagrid.pager.next",previous:"datagrid.pager.previous",filler:"datagrid.pager.filler"}},l={from:"from",to:"to",items:"items",totalItems:"totalItems",perPage:"perPage",pages:"pages",page:"page",term:"term",sort:"sort",asc:"A",desc:"D"},p={table:{selector:".dgTable",regionType:n.TableRegion,view:n.TableView},toolbar:{selector:".dgToolbar",view:n.ToolbarView},quickSearch:{selector:".dgQuickSearch",view:n.QuickSearchView},perPage:{selector:".dgPerPage",view:n.PerPageView},info:{selector:".dgInfo",view:n.InfoView},pager:{selector:".dgPager",view:n.PagerView}},n.setupDefaultI18nBindings=function(e){return u=r.defaults(e.i18n||{},u)},n.setupDefaultInfoBindings=function(e){return l=r.defaults(e.bindings||{},l)},n.setupDefaultGridLayout=function(e){return p=a(e.gridRegions||{},p)},n}(Backbone,Backbone.Marionette,_,$||window.jQuery||window.Zepto||window.ender)}).call(this);